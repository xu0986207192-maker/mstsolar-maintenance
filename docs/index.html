<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#667eea">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="å…‰é›»ç¶­ä¿®">
<title>å¤ªé™½å…‰é›»ç¶­ä¿®ç®¡ç†ç³»çµ± v2-Fixed</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Microsoft JhengHei','PingFang TC',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;}
.container{max-width:1200px;margin:0 auto;background:white;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,0.3);overflow:hidden;}
.header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:25px 30px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;}
.header-left h1{font-size:24px;margin-bottom:5px;}
.header-left p{opacity:.9;font-size:13px;}
.header-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.sync-status{background:rgba(255,255,255,.2);padding:7px 14px;border-radius:20px;font-size:13px;display:flex;align-items:center;gap:7px;}
.sync-dot{width:9px;height:9px;border-radius:50%;background:#4ade80;animation:pulse 2s infinite;}
.sync-dot.syncing{background:#fbbf24;}
.sync-dot.offline{background:#ef4444;animation:none;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.5;}}

/* NAV TABS */
.nav-tabs{display:flex;background:#f8f9fa;border-bottom:2px solid #e9ecef;overflow-x:auto;}
.nav-tab{padding:14px 22px;cursor:pointer;font-weight:600;font-size:14px;color:#6c757d;border-bottom:3px solid transparent;white-space:nowrap;transition:all .2s;}
.nav-tab:hover{color:#667eea;}
.nav-tab.active{color:#667eea;border-bottom-color:#667eea;background:white;}

/* BUTTONS */
.btn{padding:10px 18px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;transition:all .3s;font-family:inherit;}
.btn-primary{background:#667eea;color:white;}
.btn-primary:hover{background:#5568d3;transform:translateY(-1px);box-shadow:0 4px 12px rgba(102,126,234,.4);}
.btn-success{background:#28a745;color:white;}
.btn-success:hover{background:#218838;}
.btn-danger{background:#dc3545;color:white;}
.btn-danger:hover{background:#c82333;}
.btn-warning{background:#ffc107;color:#212529;}
.btn-info{background:#17a2b8;color:white;}
.btn-outline{background:white;color:#667eea;border:2px solid #667eea;}
.btn-outline:hover{background:#667eea;color:white;}
.btn-sm{padding:6px 12px;font-size:12px;}
.btn-logout{background:rgba(255,255,255,.2);color:white;border:1px solid rgba(255,255,255,.3);font-size:13px;}
.btn-logout:hover{background:rgba(255,255,255,.3);}

/* FORMS */
.form-group{margin-bottom:18px;}
.form-label{display:block;margin-bottom:7px;color:#495057;font-weight:600;font-size:14px;}
.form-input,.form-select,.form-textarea{width:100%;padding:11px;border:2px solid #dee2e6;border-radius:8px;font-size:14px;font-family:inherit;transition:border-color .2s;}
.form-input:focus,.form-select:focus,.form-textarea:focus{outline:none;border-color:#667eea;}
.form-textarea{resize:vertical;min-height:80px;}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:15px;}

/* CONTROLS */
.controls{padding:20px 25px;background:#f8f9fa;border-bottom:2px solid #e9ecef;}
.control-row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px;}
.control-row:last-child{margin-bottom:0;}
.btn-filter{background:white;color:#495057;border:2px solid #dee2e6;padding:9px 16px;}
.btn-filter.active{background:#667eea;color:white;border-color:#667eea;}
.search-box{flex:1;min-width:220px;position:relative;}
.search-box input{width:100%;padding:10px 15px;border:2px solid #dee2e6;border-radius:8px;font-size:14px;font-family:inherit;}
.search-box input:focus{outline:none;border-color:#667eea;}

/* CONTENT */
.content{padding:25px;}

/* STATS */
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:15px;margin-bottom:25px;}
.stat-card{padding:18px;border-radius:12px;text-align:center;cursor:pointer;transition:all .2s;}
.stat-card:hover{transform:translateY(-3px);box-shadow:0 5px 15px rgba(0,0,0,.15);}
.stat-card.active{outline:3px solid #667eea;}
.stat-card.total{background:linear-gradient(135deg,#f5f7fa,#c3cfe2);}
.stat-card.pending{background:linear-gradient(135deg,#ffecd2,#fcb69f);}
.stat-card.inprogress{background:linear-gradient(135deg,#cce5ff,#99caff);}
.stat-card.completed{background:linear-gradient(135deg,#a8edea,#fed6e3);}
.stat-number{font-size:28px;font-weight:bold;color:#2d3748;margin-bottom:4px;}
.stat-label{font-size:13px;color:#4a5568;}

/* TABLE */
.records-table{border-radius:12px;overflow:hidden;border:1px solid #e9ecef;}
.table-header{background:#f8f9fa;padding:14px 18px;border-bottom:2px solid #dee2e6;font-weight:600;color:#495057;display:flex;justify-content:space-between;align-items:center;font-size:14px;}
.record-item{padding:18px;border-bottom:1px solid #e9ecef;transition:background .15s;}
.record-item:hover{background:#f8f9fa;}
.record-item:last-child{border-bottom:none;}
.record-grid{display:grid;grid-template-columns:1.8fr 1.8fr 1.2fr 1.2fr 1fr auto;gap:12px;align-items:center;}
.record-field .label{color:#6c757d;font-size:11px;margin-bottom:3px;}
.record-field .value{color:#2d3748;font-weight:500;font-size:14px;}
.record-field .value.link{color:#667eea;cursor:pointer;text-decoration:underline;touch-action:manipulation;-webkit-tap-highlight-color:rgba(102,126,234,0.2);}
.record-field .value.link:hover{color:#5568d3;}
.record-field .value.link:active{color:#4557c2;}
.record-actions{display:flex;gap:6px;flex-wrap:wrap;}
.record-actions .btn{touch-action:manipulation;min-width:44px;min-height:44px;display:inline-flex;align-items:center;justify-content:center;}
.status-badge{display:inline-block;padding:5px 11px;border-radius:20px;font-size:12px;font-weight:600;}
.badge-pending{background:#fff3cd;color:#856404;}
.badge-inprogress{background:#cce5ff;color:#004085;}
.badge-completed{background:#d4edda;color:#155724;}
.record-meta{margin-top:8px;display:flex;gap:15px;font-size:12px;color:#6c757d;}
.record-photos{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;}
.record-photo{width:60px;height:60px;object-fit:cover;border-radius:6px;cursor:pointer;border:2px solid #e9ecef;touch-action:manipulation;}

/* PAGINATION */
.pagination{display:flex;justify-content:center;align-items:center;gap:8px;padding:18px;flex-wrap:wrap;}
.pagination button{padding:7px 14px;border:2px solid #667eea;background:white;color:#667eea;border-radius:6px;cursor:pointer;font-weight:600;transition:all .2s;font-size:13px;}
.pagination button:hover:not(:disabled){background:#667eea;color:white;}
.pagination button:disabled{opacity:.3;cursor:not-allowed;}
.pagination button.active{background:#667eea;color:white;}
.pagination-info{color:#6c757d;font-size:13px;}

/* MODAL */
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:1000;align-items:center;justify-content:center;padding:20px;}
.modal.active{display:flex;}
.modal-content{background:white;border-radius:16px;width:100%;max-width:620px;max-height:90vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3);}
.modal-header{padding:22px 25px;border-bottom:2px solid #e9ecef;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:white;z-index:10;}
.modal-header h2{color:#2d3748;font-size:20px;}
.close-btn{background:none;border:none;font-size:26px;cursor:pointer;color:#6c757d;line-height:1;}
.modal-body{padding:25px;}
.form-actions{display:flex;gap:10px;justify-content:flex-end;margin-top:20px;}

/* PHOTO UPLOAD */
.photo-upload-area{border:2px dashed #dee2e6;border-radius:8px;padding:25px;text-align:center;cursor:pointer;transition:all .2s;margin-bottom:10px;}
.photo-upload-area:hover{border-color:#667eea;background:#f0f2ff;}
.photo-preview-grid{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px;}
.photo-preview{position:relative;width:80px;height:80px;}
.photo-preview img{width:100%;height:100%;object-fit:cover;border-radius:6px;}
.photo-preview .remove-photo{position:absolute;top:-5px;right:-5px;background:#dc3545;color:white;border:none;border-radius:50%;width:20px;height:20px;font-size:12px;cursor:pointer;display:flex;align-items:center;justify-content:center;}

/* HISTORY PAGE */
.history-header{display:flex;align-items:center;gap:12px;margin-bottom:20px;}
.back-btn{background:#f8f9fa;border:2px solid #dee2e6;color:#495057;padding:8px 16px;border-radius:8px;cursor:pointer;font-weight:600;font-size:14px;}
.back-btn:hover{background:#e9ecef;}
.history-title{font-size:20px;font-weight:bold;color:#2d3748;}
.history-subtitle{font-size:14px;color:#6c757d;margin-top:3px;}

/* KPI PAGE */
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:25px;}
.kpi-card{background:white;border-radius:12px;padding:20px;border:1px solid #e9ecef;box-shadow:0 2px 8px rgba(0,0,0,.06);}
.kpi-card h3{font-size:13px;color:#6c757d;margin-bottom:10px;text-transform:uppercase;letter-spacing:.5px;}
.kpi-value{font-size:30px;font-weight:bold;color:#2d3748;margin-bottom:5px;}
.kpi-sub{font-size:13px;color:#6c757d;}
.kpi-bar{background:#e9ecef;border-radius:10px;height:8px;margin-top:8px;}
.kpi-bar-fill{background:#667eea;border-radius:10px;height:100%;transition:width .5s;}
.chart-section{background:white;border-radius:12px;padding:20px;border:1px solid #e9ecef;margin-bottom:20px;}
.chart-section h3{font-size:16px;font-weight:600;color:#2d3748;margin-bottom:15px;}
.bar-chart{display:flex;align-items:flex-end;gap:10px;height:160px;padding-bottom:25px;border-bottom:2px solid #e9ecef;position:relative;}
.bar-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:5px;}
.bar{width:100%;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:6px 6px 0 0;transition:height .5s;min-height:4px;position:relative;}
.bar:hover::after{content:attr(data-value);position:absolute;top:-25px;left:50%;transform:translateX(-50%);background:#2d3748;color:white;padding:3px 8px;border-radius:4px;font-size:12px;white-space:nowrap;}
.bar-label{font-size:11px;color:#6c757d;text-align:center;}
.top-list{list-style:none;}
.top-list li{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid #e9ecef;font-size:14px;}
.top-list li:last-child{border-bottom:none;}
.top-list .rank{background:#667eea;color:white;width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold;margin-right:10px;}
.top-list .name{flex:1;color:#2d3748;}
.top-list .count{font-weight:bold;color:#667eea;}

/* LOGIN */
.login-screen{padding:50px 30px;text-align:center;max-width:440px;margin:0 auto;}
.login-screen h2{color:#2d3748;margin-bottom:12px;font-size:22px;}
.login-screen p{color:#6c757d;margin-bottom:28px;line-height:1.6;}
.alert{padding:12px 18px;border-radius:8px;margin-bottom:18px;font-size:14px;}
.alert-success{background:#d4edda;color:#155724;border:1px solid #c3e6cb;}
.alert-warning{background:#fff3cd;color:#856404;border:1px solid #ffeaa7;}
.alert-info{background:#cce5ff;color:#004085;border:1px solid #b8daff;}
.empty-state{text-align:center;padding:50px 20px;color:#6c757d;}
.empty-icon{font-size:56px;margin-bottom:15px;opacity:.3;}
.loading{text-align:center;padding:40px;}
.spinner{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:38px;height:38px;animation:spin 1s linear infinite;margin:0 auto 15px;}
@keyframes spin{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}

/* LIGHTBOX */
.lightbox{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);z-index:2000;align-items:center;justify-content:center;}
.lightbox.active{display:flex;}
.lightbox img{max-width:90%;max-height:90%;border-radius:8px;}
.lightbox-close{position:absolute;top:20px;right:25px;color:white;font-size:35px;cursor:pointer;}

@media(max-width:768px){
  .record-grid{grid-template-columns:1fr;gap:8px;}
  .record-field .value.link{
    display:block;
    padding:10px 5px;
    margin:-10px -5px;
  }
  .record-actions .btn{
    min-width:48px;
    min-height:48px;
    font-size:16px;
  }
  .form-row{grid-template-columns:1fr;}
  .header{flex-direction:column;}
  .kpi-grid{grid-template-columns:1fr 1fr;}
  .nav-tab{
    min-height:48px;
    display:flex;
    align-items:center;
  }
  .btn{
    min-height:44px;
  }
}
</style>
</head>
<body>

<!-- ç™»å…¥ç•«é¢ -->
<div id="loginScreen" class="container">
  <div class="header"><div class="header-left"><h1>â˜€ï¸ å¤ªé™½å…‰é›»ç¶­ä¿®ç®¡ç†ç³»çµ±</h1><p>Firebase é›²ç«¯å³æ™‚åŒæ­¥ç‰ˆ v2.0</p></div></div>
  <div class="login-screen">
    <h2>ğŸ” è¨­å®šæ‚¨çš„å·¥ä½œå€</h2>
    <p>è«‹è¨­å®šå·¥ä½œå€ä»£ç¢¼ï¼Œæ‰€æœ‰è£ç½®ä½¿ç”¨ç›¸åŒä»£ç¢¼å³å¯å³æ™‚åŒæ­¥ã€‚</p>
    <div class="alert alert-success">âœ… å·²é€£æ¥ Firebase é›²ç«¯ â€” æ‰‹æ©Ÿé›»è…¦å³æ™‚åŒæ­¥ï¼</div>
    <form onsubmit="login(event)">
      <div class="form-group" style="text-align:left">
        <label class="form-label">å·¥ä½œå€ä»£ç¢¼ *</label>
        <input type="text" class="form-input" id="workspaceId" required placeholder="ä¾‹å¦‚ï¼šé™½å…‰å·¥ç¨‹" minlength="3">
        <small style="color:#6c757d;font-size:12px">æ‰€æœ‰è£ç½®ä½¿ç”¨ç›¸åŒä»£ç¢¼å³å¯åŒæ­¥</small>
      </div>
      <div class="form-group" style="text-align:left">
        <label class="form-label">æ‚¨çš„å§“åï¼ˆé¸å¡«ï¼‰</label>
        <input type="text" class="form-input" id="userName" placeholder="ä¾‹å¦‚ï¼šå¼µå¿—æ˜">
      </div>
      <div class="form-group" style="text-align:left">
        <label class="form-label">ç®¡ç†å“¡å¯†ç¢¼ï¼ˆé¸å¡«ï¼‰</label>
        <input type="password" class="form-input" id="adminPass" placeholder="ç•™ç©ºç‚ºä¸€èˆ¬æˆå“¡ï¼Œè¼¸å…¥å¯†ç¢¼ç‚ºç®¡ç†å“¡">
        <small style="color:#6c757d;font-size:12px">ç®¡ç†å“¡å¯åˆªé™¤ç´€éŒ„ã€åŒ¯å‡ºå ±å‘Šã€æŸ¥çœ‹KPI</small>
      </div>
      <button type="submit" class="btn btn-primary" style="width:100%;padding:14px;font-size:16px">é€²å…¥å·¥ä½œå€</button>
    </form>
    <div class="alert alert-warning" style="margin-top:18px">âš ï¸ è«‹è¨˜ä½å·¥ä½œå€ä»£ç¢¼ï¼Œå…¶ä»–è£ç½®éœ€è¦ç›¸åŒä»£ç¢¼æ‰èƒ½åŒæ­¥</div>
  </div>
</div>

<!-- ä¸»æ‡‰ç”¨ç¨‹å¼ -->
<div id="mainApp" class="container" style="display:none">
  <div class="header">
    <div class="header-left">
      <h1>â˜€ï¸ å¤ªé™½å…‰é›»ç¶­ä¿®ç®¡ç†ç³»çµ±</h1>
      <p>å·¥ä½œå€ï¼š<span id="wsDisplay"></span> | ä½¿ç”¨è€…ï¼š<span id="userDisplay"></span></p>
    </div>
    <div class="header-right">
      <div class="sync-status"><div class="sync-dot" id="syncDot"></div><span id="syncText">é€£ç·šä¸­...</span></div>
      <span id="adminBadge" style="display:none;background:#ffc107;color:#212529;padding:5px 12px;border-radius:20px;font-size:12px;font-weight:700">ğŸ‘‘ ç®¡ç†å“¡</span>
      <button class="btn btn-logout" onclick="logout()">ç™»å‡º</button>
    </div>
  </div>

  <!-- å°è¦½åˆ— -->
  <div class="nav-tabs">
    <div class="nav-tab active" onclick="showTab('main')">ğŸ“‹ ç¶­ä¿®ç´€éŒ„</div>
    <div class="nav-tab" id="kpiTab" onclick="showTab('kpi')">ğŸ“Š KPI çµ±è¨ˆ</div>
    <div class="nav-tab" onclick="showTab('calculator')">ğŸ”¢ PR/RA è¨ˆç®—</div>
    <div class="nav-tab" id="adminTab" style="display:none" onclick="showTab('admin')">âš™ï¸ ç®¡ç†è¨­å®š</div>
  </div>

  <!-- ä¸»é é¢ -->
  <div id="tabMain">
    <div class="controls">
      <div class="control-row">
        <div class="btn-group" style="display:flex;gap:8px;flex-wrap:wrap">
          <button class="btn btn-filter active" onclick="filterPeriod('all',this)">æ‰€æœ‰ç´€éŒ„</button>
          <button class="btn btn-filter" onclick="filterPeriod('today',this)">ä»Šæ—¥</button>
          <button class="btn btn-filter" onclick="filterPeriod('week',this)">æœ¬é€±</button>
          <button class="btn btn-filter" onclick="filterPeriod('month',this)">æœ¬æœˆ</button>
          <button class="btn btn-filter" onclick="filterPeriod('year',this)">å¹´åº¦</button>
          <button class="btn btn-filter" onclick="filterPeriod('custom',this)">è‡ªè¨‚å€é–“</button>
        </div>
        <div class="search-box">
          <input type="text" id="searchInput" placeholder="ğŸ” æœå°‹ä»»ä½•é—œéµå­—..." oninput="onSearch()">
        </div>
        <button class="btn btn-info" onclick="exportCSV()">ğŸ“¥ åŒ¯å‡º</button>
        <button class="btn btn-warning admin-only" style="display:none" onclick="openImportModal()">ğŸ“¤ åŒ¯å…¥</button>
        <button class="btn btn-primary" onclick="openAddModal()">â• æ–°å¢è¨˜éŒ„</button>
      </div>
      <div id="dateRangeRow" style="display:none" class="control-row">
        <label style="font-weight:600;color:#495057">æ—¥æœŸå€é–“ï¼š</label>
        <input type="date" id="startDate" class="form-input" style="width:auto;padding:8px" onchange="renderRecords()">
        <span style="color:#6c757d">è‡³</span>
        <input type="date" id="endDate" class="form-input" style="width:auto;padding:8px" onchange="renderRecords()">
      </div>
    </div>

    <div class="content">
      <div class="stats" id="statsRow">
        <div class="stat-card total active" onclick="filterStatus('all',this)">
          <div class="stat-number" id="sTotal">0</div><div class="stat-label">ç¸½ç¶­ä¿®ç´€éŒ„</div>
        </div>
        <div class="stat-card pending" onclick="filterStatus('å¾…è™•ç†',this)">
          <div class="stat-number" id="sPending">0</div><div class="stat-label">å¾…è™•ç†</div>
        </div>
        <div class="stat-card inprogress" onclick="filterStatus('é€²è¡Œä¸­',this)">
          <div class="stat-number" id="sInProgress">0</div><div class="stat-label">é€²è¡Œä¸­</div>
        </div>
        <div class="stat-card completed" onclick="filterStatus('å·²å®Œæˆ',this)">
          <div class="stat-number" id="sCompleted">0</div><div class="stat-label">å·²å®Œæˆ</div>
        </div>
      </div>

      <div class="records-table">
        <div class="table-header">
          <span id="periodTitle">æ‰€æœ‰ç¶­ä¿®ç´€éŒ„</span>
          <span style="font-size:12px;font-weight:normal;color:#6c757d" id="recordCount"></span>
        </div>
        <div id="recordsList"><div class="loading"><div class="spinner"></div><p>è¼‰å…¥è³‡æ–™ä¸­...</p></div></div>
        <div class="pagination" id="paginationEl" style="display:none"></div>
      </div>
    </div>
  </div>

  <!-- KPI é é¢ -->
  <div id="tabKpi" style="display:none">
    <div class="content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:10px">
        <h2 style="color:#2d3748">ğŸ“Š KPI çµ±è¨ˆå ±è¡¨</h2>
        <button class="btn btn-primary" onclick="exportKpiPDF()">ğŸ“„ åŒ¯å‡º PDF å ±å‘Š</button>
      </div>
      <div class="kpi-grid" id="kpiGrid"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;flex-wrap:wrap" id="kpiCharts"></div>
    </div>
  </div>

  <!-- æ­·å²é é¢ï¼ˆå®¢æˆ¶/é …ç›®ï¼‰ -->
  <div id="tabHistory" style="display:none">
    <div class="content">
      <div class="history-header">
        <button class="back-btn" onclick="showTab('main')">â† è¿”å›</button>
        <div>
          <div class="history-title" id="historyTitle"></div>
          <div class="history-subtitle" id="historySubtitle"></div>
        </div>
        <button class="btn btn-primary" style="margin-left:auto" onclick="exportHistoryPDF()">ğŸ“„ åŒ¯å‡º PDF</button>
      </div>
      <div class="records-table">
        <div class="table-header"><span id="historyTableTitle">æ­·å²ç´€éŒ„</span></div>
        <div id="historyList"></div>
      </div>
    </div>
  </div>

  <!-- PR/RA è¨ˆç®—å™¨é é¢ -->
  <div id="tabCalculator" style="display:none">
    <div class="content">
      <h2 style="color:#2d3748;font-size:20px;margin-bottom:20px">ğŸ”¢ PR å€¼èˆ‡ RA å€¼è¨ˆç®—å™¨</h2>
      
      <!-- PR å€¼è¨ˆç®— -->
      <div class="card-section">
        <h3 style="font-size:16px;font-weight:700;color:#2d3748;margin-bottom:15px">ğŸ“Š PR å€¼ï¼ˆPerformance Ratioï¼‰è¨ˆç®—</h3>
        <p style="color:#6c757d;font-size:13px;margin-bottom:15px">PR å€¼ = å¯¦éš›ç™¼é›»é‡ Ã· (æ—¥ç…§å¼·åº¦ Ã— ç³»çµ±å®¹é‡ Ã— æ™‚æ•¸) Ã— 100%</p>
        
        <div class="row2">
          <div class="form-group">
            <label class="form-label">å¯¦éš›ç™¼é›»é‡ï¼ˆkWhï¼‰</label>
            <input type="number" class="form-input" id="pr_actual" step="0.01" placeholder="ä¾‹å¦‚ï¼š850">
          </div>
          <div class="form-group">
            <label class="form-label">æ—¥ç…§å¼·åº¦ï¼ˆW/mÂ²ï¼‰</label>
            <input type="number" class="form-input" id="pr_irradiation" step="0.01" placeholder="ä¾‹å¦‚ï¼š800">
          </div>
        </div>
        <div class="row2">
          <div class="form-group">
            <label class="form-label">ç³»çµ±å®¹é‡ï¼ˆkWpï¼‰</label>
            <input type="number" class="form-input" id="pr_capacity" step="0.01" placeholder="ä¾‹å¦‚ï¼š200">
          </div>
          <div class="form-group">
            <label class="form-label">æ—¥ç…§æ™‚æ•¸ï¼ˆå°æ™‚ï¼‰</label>
            <input type="number" class="form-input" id="pr_hours" step="0.1" placeholder="ä¾‹å¦‚ï¼š5.5">
          </div>
        </div>
        <button class="btn btn-primary" onclick="calculatePR()">è¨ˆç®— PR å€¼</button>
        
        <div id="prResult" style="display:none;margin-top:20px;padding:20px;background:#f0f2ff;border-radius:12px;border-left:4px solid #667eea">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-size:14px;color:#2d3748"><strong>è¨ˆç®—çµæœï¼š</strong></div>
            <button class="btn btn-sm" style="background:#667eea;color:white" onclick="exportCalcPDF('PR')">ğŸ“„ åŒ¯å‡º PDF</button>
          </div>
          <div style="font-size:32px;font-weight:bold;color:#667eea;margin-bottom:8px" id="prValue"></div>
          <div style="font-size:13px;color:#6c757d;margin-bottom:8px" id="prDetails"></div>
          <div style="font-size:13px;color:#6c757d" id="prStatus"></div>
          <div style="margin-top:12px;padding-top:12px;border-top:1px solid #dee2e6;font-size:12px;color:#6c757d">
            <strong>è©•åƒ¹æ¨™æº–ï¼š</strong><br>
            å„ªè‰¯ï¼šPR â‰¥ 80% | è‰¯å¥½ï¼š70% â‰¤ PR < 80% | æ™®é€šï¼š60% â‰¤ PR < 70% | éœ€æ”¹å–„ï¼šPR < 60%
          </div>
        </div>
      </div>

      <!-- RA å€¼è¨ˆç®— -->
      <div class="card-section" style="margin-top:20px">
        <h3 style="font-size:16px;font-weight:700;color:#2d3748;margin-bottom:15px">âš¡ RA å€¼ï¼ˆå¤ªé™½èƒ½ç³»çµ±å¯ç”¨ç‡ï¼‰è¨ˆç®—</h3>
        <p style="color:#6c757d;font-size:13px;margin-bottom:15px">RA å€¼ = (å¯¦æ¸¬ä¸²åˆ—åŠŸç‡ Ã· é¡å®šè£ç½®å®¹é‡) Ã— 100%</p>
        
        <div class="row2">
          <div class="form-group">
            <label class="form-label">å¯¦æ¸¬ä¸²åˆ—åŠŸç‡ï¼ˆkWï¼‰</label>
            <input type="number" class="form-input" id="ra_measured" step="0.01" placeholder="ä¾‹å¦‚ï¼š180">
            <small style="color:#6c757d;font-size:12px">æ–¼ç‰¹å®šæ—¥ç…§èˆ‡æº«åº¦ä¸‹é‡æ¸¬çš„å¯¦éš›åŠŸç‡</small>
          </div>
          <div class="form-group">
            <label class="form-label">é¡å®šè£ç½®å®¹é‡ï¼ˆkWpï¼‰</label>
            <input type="number" class="form-input" id="ra_rated" step="0.01" placeholder="ä¾‹å¦‚ï¼š200">
            <small style="color:#6c757d;font-size:12px">æ¨™æº–æ¸¬è©¦æ¢ä»¶(STC)ä¸‹çš„é¡å®šåŠŸç‡</small>
          </div>
        </div>
        <div class="row2">
          <div class="form-group">
            <label class="form-label">é‡æ¸¬æ™‚æ—¥ç…§å¼·åº¦ï¼ˆW/mÂ²ï¼‰</label>
            <input type="number" class="form-input" id="ra_irradiance" step="0.01" placeholder="ä¾‹å¦‚ï¼š850">
          </div>
          <div class="form-group">
            <label class="form-label">é‡æ¸¬æ™‚æ¨¡çµ„æº«åº¦ï¼ˆÂ°Cï¼‰</label>
            <input type="number" class="form-input" id="ra_temperature" step="0.1" placeholder="ä¾‹å¦‚ï¼š45">
          </div>
        </div>
        <button class="btn btn-primary" onclick="calculateRA()">è¨ˆç®— RA å€¼</button>
        
        <div id="raResult" style="display:none;margin-top:20px;padding:20px;background:#f0fff4;border-radius:12px;border-left:4px solid #28a745">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div style="font-size:14px;color:#2d3748"><strong>è¨ˆç®—çµæœï¼š</strong></div>
            <button class="btn btn-sm" style="background:#28a745;color:white" onclick="exportCalcPDF('RA')">ğŸ“„ åŒ¯å‡º PDF</button>
          </div>
          <div style="font-size:32px;font-weight:bold;color:#28a745;margin-bottom:8px" id="raValue"></div>
          <div style="font-size:13px;color:#6c757d;margin-bottom:8px" id="raConditions"></div>
          <div style="margin-top:12px;padding-top:12px;border-top:1px solid #dee2e6;font-size:12px;color:#6c757d">
            <strong>è©•åƒ¹æ¨™æº–ï¼š</strong><br>
            å„ªè‰¯ï¼šRA â‰¥ 90% | è‰¯å¥½ï¼š80% â‰¤ RA < 90% | æ™®é€šï¼š70% â‰¤ RA < 80% | éœ€æ”¹å–„ï¼šRA < 70%
          </div>
        </div>
      </div>

      <!-- æ­·å²ç´€éŒ„ -->
      <div class="card-section" style="margin-top:20px">
        <h3 style="font-size:16px;font-weight:700;color:#2d3748;margin-bottom:15px">ğŸ“‹ è¨ˆç®—æ­·å²</h3>
        <div id="calcHistory">
          <p style="color:#6c757d;font-size:13px">å°šç„¡è¨ˆç®—ç´€éŒ„</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ç®¡ç†è¨­å®šé é¢ -->
  <div id="tabAdmin" style="display:none">
    <div class="content">
      <h2 style="color:#2d3748;margin-bottom:20px">âš™ï¸ ç®¡ç†å“¡è¨­å®š</h2>

      <!-- è¨­å®šç®¡ç†å“¡å¯†ç¢¼ -->
      <div class="kpi-card" style="margin-bottom:20px;border:1px solid #e9ecef;border-radius:12px;padding:25px">
        <h3 style="font-size:16px;font-weight:700;color:#2d3748;margin-bottom:15px">ğŸ”‘ æ›´æ”¹ç®¡ç†å“¡å¯†ç¢¼</h3>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">æ–°å¯†ç¢¼</label>
            <input type="password" class="form-input" id="newAdminPass" placeholder="è¼¸å…¥æ–°çš„ç®¡ç†å“¡å¯†ç¢¼">
          </div>
          <div class="form-group">
            <label class="form-label">ç¢ºèªå¯†ç¢¼</label>
            <input type="password" class="form-input" id="confirmAdminPass" placeholder="å†æ¬¡è¼¸å…¥å¯†ç¢¼">
          </div>
        </div>
        <button class="btn btn-primary" onclick="changeAdminPass()">æ›´æ–°å¯†ç¢¼</button>
      </div>

      <!-- æˆå“¡ç®¡ç† -->
      <div class="kpi-card" style="margin-bottom:20px;border:1px solid #e9ecef;border-radius:12px;padding:25px">
        <h3 style="font-size:16px;font-weight:700;color:#2d3748;margin-bottom:15px">ğŸ‘¥ å·¥ä½œå€æˆå“¡æ´»å‹•</h3>
        <div id="memberList"><div class="loading"><div class="spinner"></div><p>è¼‰å…¥ä¸­...</p></div></div>
      </div>

      <!-- å±éšªå€åŸŸ -->
      <div style="border:2px solid #dc3545;border-radius:12px;padding:25px">
        <h3 style="font-size:16px;font-weight:700;color:#dc3545;margin-bottom:10px">âš ï¸ å±éšªå€åŸŸ</h3>
        <p style="color:#6c757d;font-size:14px;margin-bottom:15px">ä»¥ä¸‹æ“ä½œä¸å¯å¾©åŸï¼Œè«‹è¬¹æ…ä½¿ç”¨</p>
        <button class="btn btn-danger" onclick="clearAllRecords()">ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>
      </div>
    </div>
  </div>
</div>

<!-- æ–°å¢/ç·¨è¼¯æ¨¡æ…‹æ¡† -->
<div class="modal" id="recordModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 id="modalTitle">æ–°å¢ç¶­ä¿®è¨˜éŒ„</h2>
      <button class="close-btn" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <form onsubmit="saveRecord(event)">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">å®¢æˆ¶åç¨± *</label>
            <input type="text" class="form-input" id="f_customer" required list="customerList">
            <datalist id="customerList"></datalist>
          </div>
          <div class="form-group">
            <label class="form-label">ç¶­ä¿®äººå“¡ *</label>
            <input type="text" class="form-input" id="f_technician" required>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">ç¶­ä¿®é …ç›® *ï¼ˆå¯è¤‡é¸ï¼‰</label>
          <div style="border:2px solid #dee2e6;border-radius:8px;padding:15px;max-height:250px;overflow-y:auto">
            <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;transition:background .2s" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
              <input type="checkbox" name="repairItems" value="å°é”é€†è®Šå™¨æ•…éšœ" style="margin-right:10px;width:18px;height:18px"> å°é”é€†è®Šå™¨æ•…éšœ
            </label>
            <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;transition:background .2s" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
              <input type="checkbox" name="repairItems" value="æ–°æœ›é€†è®Šå™¨æ•…éšœ" style="margin-right:10px;width:18px;height:18px"> æ–°æœ›é€†è®Šå™¨æ•…éšœ
            </label>
            <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;transition:background .2s" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
              <input type="checkbox" name="repairItems" value="å¤ç‘ç“¦ç‰¹é€†è®Šå™¨æ•…éšœ" style="margin-right:10px;width:18px;height:18px"> å¤ç‘ç“¦ç‰¹é€†è®Šå™¨æ•…éšœ
            </label>
            <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;transition:background .2s" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
              <input type="checkbox" name="repairItems" value="äºåŠ›é€†è®Šå™¨æ•…éšœ" style="margin-right:10px;width:18px;height:18px"> äºåŠ›é€†è®Šå™¨æ•…éšœ
            </label>
            <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;transition:background .2s" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
              <input type="checkbox" name="repairItems" value="ç›ˆæ­£é€†è®Šå™¨æ•…éšœ" style="margin-right:10px;width:18px;height:18px"> ç›ˆæ­£é€†è®Šå™¨æ•…éšœ
            </label>
            <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;transition:background .2s" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
              <input type="checkbox" name="repairItems" value="ç§‘é¢¨é€†è®Šå™¨æ•…éšœ" style="margin-right:10px;width:18px;height:18px"> ç§‘é¢¨é€†è®Šå™¨æ•…éšœ
            </label>
            <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;transition:background .2s" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
              <input type="checkbox" name="repairItems" value="è¯ç‚ºé€†è®Šå™¨æ•…éšœ" style="margin-right:10px;width:18px;height:18px"> è¯ç‚ºé€†è®Šå™¨æ•…éšœ
            </label>
            <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;transition:background .2s" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
              <input type="checkbox" name="repairItems" value="å¤ªé™½èƒ½æ¿ç ´æ" style="margin-right:10px;width:18px;height:18px"> å¤ªé™½èƒ½æ¿ç ´æ
            </label>
            <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;transition:background .2s" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
              <input type="checkbox" name="repairItems" value="é›»è·¯æª¢ä¿®" style="margin-right:10px;width:18px;height:18px"> é›»è·¯æª¢ä¿®
            </label>
            <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;transition:background .2s" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
              <input type="checkbox" name="repairItems" value="ç³»çµ±æ¸…æ½”ä¿é¤Š" style="margin-right:10px;width:18px;height:18px"> ç³»çµ±æ¸…æ½”ä¿é¤Š
            </label>
            <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;transition:background .2s" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
              <input type="checkbox" name="repairItems" value="ç›£æ§ç³»çµ±ç•°å¸¸" style="margin-right:10px;width:18px;height:18px"> ç›£æ§ç³»çµ±ç•°å¸¸
            </label>
            <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;transition:background .2s" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
              <input type="checkbox" name="repairItems" value="ä¸‰æƒŸç›£æ§æ•¸æ“šæ©Ÿç•°å¸¸" style="margin-right:10px;width:18px;height:18px"> ä¸‰æƒŸç›£æ§æ•¸æ“šæ©Ÿç•°å¸¸
            </label>
            <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;transition:background .2s" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
              <input type="checkbox" name="repairItems" value="ç¶²è·¯è²»æœªç¹³" style="margin-right:10px;width:18px;height:18px"> ç¶²è·¯è²»æœªç¹³
            </label>
            <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;transition:background .2s" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
              <input type="checkbox" name="repairItems" value="é…é›»ç®±ç¶­ä¿®" style="margin-right:10px;width:18px;height:18px"> é…é›»ç®±ç¶­ä¿®
            </label>
            <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;transition:background .2s" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
              <input type="checkbox" name="repairItems" value="ä¿éšªçµ²ç†”æ–·" style="margin-right:10px;width:18px;height:18px"> ä¿éšªçµ²ç†”æ–·
            </label>
            <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;transition:background .2s" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
              <input type="checkbox" name="repairItems" value="çªæ³¢ä¿è­·å™¨æ•…éšœ" style="margin-right:10px;width:18px;height:18px"> çªæ³¢ä¿è­·å™¨æ•…éšœ
            </label>
            <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;transition:background .2s" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
              <input type="checkbox" name="repairItems" value="ç«¯å­å°æ•…éšœ" style="margin-right:10px;width:18px;height:18px"> ç«¯å­å°æ•…éšœ
            </label>
            <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;transition:background .2s" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
              <input type="checkbox" name="repairItems" value="æ”¯æ¶çµæ§‹æª¢æŸ¥" style="margin-right:10px;width:18px;height:18px"> æ”¯æ¶çµæ§‹æª¢æŸ¥
            </label>
            <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;transition:background .2s" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
              <input type="checkbox" name="repairItems" value="æ¥åœ°ç³»çµ±æª¢æ¸¬" style="margin-right:10px;width:18px;height:18px"> æ¥åœ°ç³»çµ±æª¢æ¸¬
            </label>
            <label style="display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:6px;transition:background .2s" onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
              <input type="checkbox" name="repairItems" value="ç·šè·¯è€åŒ–æ›´æ›" style="margin-right:10px;width:18px;height:18px"> ç·šè·¯è€åŒ–æ›´æ›
            </label>
          </div>
          <div style="margin-top:10px;display:flex;align-items:center;gap:10px">
            <input type="checkbox" id="customItemCheck" style="width:18px;height:18px">
            <label for="customItemCheck" style="font-weight:600">å…¶ä»–ï¼ˆè‡ªè¨‚ï¼‰</label>
            <input type="text" class="form-input" id="customItem" style="flex:1;display:none" placeholder="è¼¸å…¥å…¶ä»–ç¶­ä¿®é …ç›®">
          </div>
        </div>
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">ç¶­ä¿®æ—¥æœŸ *</label>
            <input type="date" class="form-input" id="f_date" required>
          </div>
          <div class="form-group">
            <label class="form-label">ç‹€æ…‹ *</label>
            <select class="form-select" id="f_status">
              <option value="å¾…è™•ç†">å¾…è™•ç†</option>
              <option value="é€²è¡Œä¸­">é€²è¡Œä¸­</option>
              <option value="å·²å®Œæˆ">å·²å®Œæˆ</option>
            </select>
          </div>
        </div>
        <div class="form-group">
          <label class="form-label">å‚™è¨»</label>
          <textarea class="form-textarea" id="f_notes" placeholder="è©³ç´°èªªæ˜ã€é›¶ä»¶ã€è²»ç”¨ç­‰..."></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">ğŸ“¸ ä¸Šå‚³ç…§ç‰‡</label>
          <div class="photo-upload-area" onclick="document.getElementById('photoInput').click()">
            <div style="font-size:28px;margin-bottom:8px">ğŸ“·</div>
            <div style="color:#6c757d;font-size:14px">é»æ“Šé¸æ“‡ç…§ç‰‡ï¼ˆå¯å¤šå¼µï¼‰</div>
          </div>
          <input type="file" id="photoInput" accept="image/*" multiple style="display:none" onchange="handlePhotos(this)">
          <div class="photo-preview-grid" id="photoPreview"></div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn" style="background:#6c757d;color:white" onclick="closeModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary" id="saveBtn">å„²å­˜</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- åŒ¯å…¥ CSV Modal -->
<div class="modal" id="importModal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ğŸ“¤ åŒ¯å…¥ CSV è³‡æ–™</h2>
      <button class="close-btn" onclick="closeImportModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div class="alert alert-info">é¸æ“‡ä¹‹å‰åŒ¯å‡ºçš„ CSV æª”æ¡ˆé€²è¡ŒåŒ¯å…¥</div>
      <div class="form-group">
        <label class="form-label">é¸æ“‡ CSV æª”æ¡ˆ</label>
        <input type="file" class="form-input" id="csvFile" accept=".csv" style="padding:8px">
      </div>
      <div class="form-actions">
        <button type="button" class="btn btn-cancel" onclick="closeImportModal()">å–æ¶ˆ</button>
        <button type="button" class="btn btn-primary" onclick="doImportCSV()">é–‹å§‹åŒ¯å…¥</button>
      </div>
    </div>
  </div>
</div>

<!-- ç…§ç‰‡ç‡ˆç®± -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <span class="lightbox-close">&times;</span>
  <img id="lightboxImg" src="" alt="">
</div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, set, push, remove, onValue, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
import { getStorage, ref as sRef, uploadString, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

const firebaseConfig = {
  apiKey: "AIzaSyCbz3jN6PBRcEGcuknZEs2Sp0VOIfPWhr8",
  authDomain: "mstsolar-maintenance.firebaseapp.com",
  databaseURL: "https://mstsolar-maintenance-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "mstsolar-maintenance",
  storageBucket: "mstsolar-maintenance.firebasestorage.app",
  messagingSenderId: "1061682843376",
  appId: "1:1061682843376:web:8c9255f9e390bfc64efc35"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const storage = getStorage(app);

// STATE
let allRecords = [];
let ws = '', user = '';
let dbRef = null;
let currentFilter = 'all';
let statusFilter = 'all';
let currentPage = 1;
let editKey = null;
let pendingPhotos = [];
let historyMode = null;
let isAdmin = false;

const PER_PAGE = 10;
const DEFAULT_ADMIN_PASS = 'admin1234'; // é è¨­ç®¡ç†å“¡å¯†ç¢¼

function syncStatus(s, t) {
  const dot = document.getElementById('syncDot');
  const txt = document.getElementById('syncText');
  if (!dot || !txt) return;
  dot.className = 'sync-dot' + (s === 'syncing' ? ' syncing' : s === 'offline' ? ' offline' : '');
  txt.textContent = t || (s === 'syncing' ? 'åŒæ­¥ä¸­...' : s === 'offline' ? 'é›¢ç·š' : 'å·²åŒæ­¥');
}

// ---- LOGIN ----
window.login = async function(e) {
  e.preventDefault();
  
  console.log('=== é–‹å§‹ç™»å…¥æµç¨‹ ===');
  
  try {
    ws = document.getElementById('workspaceId').value.trim();
    user = document.getElementById('userName').value.trim() || 'åŒ¿å';
    const adminPassInput = document.getElementById('adminPass').value;

    console.log('å·¥ä½œå€:', ws);
    console.log('ä½¿ç”¨è€…:', user);
    console.log('ç®¡ç†å“¡å¯†ç¢¼:', adminPassInput ? 'å·²è¼¸å…¥' : 'æœªè¼¸å…¥');

    if (ws.length < 3) { 
      alert('å·¥ä½œå€ä»£ç¢¼è‡³å°‘éœ€è¦ 3 å€‹å­—å…ƒ'); 
      return; 
    }

    // æª¢æŸ¥ç®¡ç†å“¡å¯†ç¢¼
    isAdmin = false;
    if (adminPassInput) {
      console.log('æª¢æŸ¥ç®¡ç†å“¡å¯†ç¢¼...');
      try {
        const savedPass = await getAdminPass();
        const validPass = savedPass || DEFAULT_ADMIN_PASS;
        console.log('é è¨­å¯†ç¢¼:', DEFAULT_ADMIN_PASS);
        if (adminPassInput === validPass) {
          isAdmin = true;
          console.log('ç®¡ç†å“¡é©—è­‰æˆåŠŸ');
        } else {
          alert('ç®¡ç†å“¡å¯†ç¢¼éŒ¯èª¤ï¼\nè«‹ç•™ç©ºé€²å…¥ä¸€èˆ¬æˆå“¡æ¨¡å¼ï¼Œæˆ–è¼¸å…¥æ­£ç¢ºå¯†ç¢¼ã€‚');
          return;
        }
      } catch (err) {
        console.error('å–å¾—ç®¡ç†å“¡å¯†ç¢¼å¤±æ•—:', err);
        // å¦‚æœç„¡æ³•å–å¾—å¯†ç¢¼ï¼Œä½¿ç”¨é è¨­å¯†ç¢¼æ¯”å°
        if (adminPassInput === DEFAULT_ADMIN_PASS) {
          isAdmin = true;
          console.log('ä½¿ç”¨é è¨­å¯†ç¢¼ç™»å…¥');
        } else {
          alert('ç„¡æ³•é©—è­‰ç®¡ç†å“¡å¯†ç¢¼ï¼Œè«‹ç¢ºèª Firebase é€£ç·šæ­£å¸¸');
          return;
        }
      }
    }

    console.log('å„²å­˜ç™»å…¥è³‡è¨Š...');
    localStorage.setItem('ws', ws);
    localStorage.setItem('user', user);
    localStorage.setItem('isAdmin', isAdmin ? '1' : '0');

    console.log('åˆ‡æ›ç•«é¢...');
    document.getElementById('loginScreen').style.display = 'none';
    document.getElementById('mainApp').style.display = 'block';
    document.getElementById('wsDisplay').textContent = ws;
    document.getElementById('userDisplay').textContent = user;

    console.log('å¥—ç”¨ç®¡ç†å“¡ä»‹é¢...');
    applyAdminUI();
    
    console.log('åˆå§‹åŒ–è³‡æ–™åº«...');
    initDB();
    
    console.log('=== ç™»å…¥å®Œæˆ ===');
  } catch (err) {
    console.error('ç™»å…¥éŒ¯èª¤:', err);
    alert('ç™»å…¥æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹æŒ‰ F12 æŸ¥çœ‹ Console éŒ¯èª¤è¨Šæ¯\n\néŒ¯èª¤ï¼š' + err.message);
  }
};

window.logout = function() {
  if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
    localStorage.removeItem('ws'); 
    localStorage.removeItem('user');
    localStorage.removeItem('isAdmin'); 
    location.reload();
  }
};

// ---- ADMIN UI ----
function applyAdminUI() {
  if (isAdmin) {
    document.getElementById('adminBadge').style.display = 'inline-flex';
    document.getElementById('adminTab').style.display = 'block';
    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'inline-flex');
  } else {
    document.getElementById('adminBadge').style.display = 'none';
    document.getElementById('adminTab').style.display = 'none';
    document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
  }
}

async function getAdminPass() {
  try {
    const snap = await new Promise((res, rej) => {
      const r = ref(db, `workspaces/${ws}/settings/adminPass`);
      onValue(r, res, { onlyOnce: true });
    });
    return snap.val();
  } catch { return null; }
}

window.changeAdminPass = async function() {
  const np = document.getElementById('newAdminPass').value;
  const cp = document.getElementById('confirmAdminPass').value;
  if (!np) { alert('è«‹è¼¸å…¥æ–°å¯†ç¢¼'); return; }
  if (np.length < 6) { alert('å¯†ç¢¼è‡³å°‘éœ€è¦ 6 å€‹å­—å…ƒ'); return; }
  if (np !== cp) { alert('å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´'); return; }
  try {
    await set(ref(db, `workspaces/${ws}/settings/adminPass`), np);
    alert('âœ… ç®¡ç†å“¡å¯†ç¢¼å·²æ›´æ–°ï¼\nä¸‹æ¬¡ç™»å…¥è«‹ä½¿ç”¨æ–°å¯†ç¢¼ã€‚');
    document.getElementById('newAdminPass').value = '';
    document.getElementById('confirmAdminPass').value = '';
  } catch (err) {
    alert('æ›´æ–°å¤±æ•—ï¼š' + err.message);
  }
};

window.clearAllRecords = async function() {
  const count = allRecords.length;
  if (!confirm(`âš ï¸ ç¢ºå®šè¦åˆªé™¤å…¨éƒ¨ ${count} ç­†ç´€éŒ„å—ï¼Ÿ\næ­¤æ“ä½œç„¡æ³•å¾©åŸï¼`)) return;
  if (!confirm('å†æ¬¡ç¢ºèªï¼šçœŸçš„è¦æ¸…é™¤æ‰€æœ‰ç´€éŒ„å—ï¼Ÿ')) return;
  try {
    await remove(ref(db, `workspaces/${ws}/records`));
    alert('å·²æ¸…é™¤æ‰€æœ‰ç´€éŒ„');
  } catch (err) {
    alert('æ¸…é™¤å¤±æ•—ï¼š' + err.message);
  }
};

// ---- DATABASE ----
function initDB() {
  syncStatus('syncing');
  dbRef = ref(db, 'workspaces/' + ws + '/records');
  
  // è¨­å®šè¶…æ™‚è™•ç†ï¼Œé¿å…å¡åœ¨è¼‰å…¥ä¸­
  let hasData = false;
  const timeout = setTimeout(() => {
    if (!hasData) {
      // å¦‚æœ 3 ç§’å¾Œé‚„æ²’è³‡æ–™ï¼Œé¡¯ç¤ºç©ºç‹€æ…‹
      allRecords = [];
      syncStatus('online', 'å·²åŒæ­¥');
      updateAutocomplete();
      renderRecords();
    }
  }, 3000);
  
  onValue(dbRef, snap => {
    hasData = true;
    clearTimeout(timeout);
    const data = snap.val();
    allRecords = data ? Object.keys(data).map(k => ({ _key: k, ...data[k] })) : [];
    syncStatus('online', 'å·²åŒæ­¥');
    updateAutocomplete();
    renderRecords();
    if (document.getElementById('tabKpi').style.display !== 'none') renderKPI();
    if (document.getElementById('tabAdmin')?.style.display !== 'none') renderMemberList();
  }, err => {
    hasData = true;
    clearTimeout(timeout);
    syncStatus('offline', 'é€£ç·šå¤±æ•—');
    console.error(err);
    // å³ä½¿é€£ç·šå¤±æ•—ä¹Ÿè¦é¡¯ç¤ºä»‹é¢
    allRecords = [];
    renderRecords();
    alert('Firebase é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯é€£ç·šæˆ– Firebase è¨­å®š');
  });
  
  document.getElementById('f_date').value = today();
}

// ---- TABS ----
window.showTab = function(tab) {
  ['tabMain','tabKpi','tabHistory','tabAdmin','tabCalculator'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.style.display = 'none';
  });
  document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
  if (tab === 'main') {
    document.getElementById('tabMain').style.display = 'block';
    document.querySelectorAll('.nav-tab')[0].classList.add('active');
  } else if (tab === 'kpi') {
    document.getElementById('tabKpi').style.display = 'block';
    document.querySelectorAll('.nav-tab')[1].classList.add('active');
    renderKPI();
  } else if (tab === 'calculator') {
    document.getElementById('tabCalculator').style.display = 'block';
    document.querySelectorAll('.nav-tab')[2].classList.add('active');
  } else if (tab === 'history') {
    document.getElementById('tabHistory').style.display = 'block';
    renderHistory();
  } else if (tab === 'admin') {
    if (!isAdmin) { alert('æ­¤åŠŸèƒ½åƒ…é™ç®¡ç†å“¡ä½¿ç”¨'); showTab('main'); return; }
    document.getElementById('tabAdmin').style.display = 'block';
    document.querySelectorAll('.nav-tab')[3].classList.add('active');
    renderMemberList();
  }
};

function renderMemberList() {
  const creators = [...new Set(allRecords.map(r => r.createdBy).filter(Boolean))];
  const el = document.getElementById('memberList');
  if (!creators.length) { el.innerHTML = '<p style="color:#6c757d;font-size:14px">ç›®å‰æ²’æœ‰æˆå“¡æ´»å‹•è¨˜éŒ„</p>'; return; }
  el.innerHTML = `<table style="width:100%;border-collapse:collapse;font-size:14px">
    <thead><tr style="background:#f8f9fa">
      <th style="padding:10px;text-align:left;border-bottom:2px solid #e9ecef">æˆå“¡å§“å</th>
      <th style="padding:10px;text-align:center;border-bottom:2px solid #e9ecef">æ–°å¢ä»¶æ•¸</th>
      <th style="padding:10px;text-align:center;border-bottom:2px solid #e9ecef">æœ€è¿‘æ´»å‹•</th>
    </tr></thead>
    <tbody>${creators.map(c => {
      const recs = allRecords.filter(r => r.createdBy === c);
      const latest = recs.sort((a,b) => new Date(b.repairDate)-new Date(a.repairDate))[0];
      return `<tr style="border-bottom:1px solid #e9ecef">
        <td style="padding:10px;font-weight:600">ğŸ‘¤ ${c}</td>
        <td style="padding:10px;text-align:center;color:#667eea;font-weight:700">${recs.length} ä»¶</td>
        <td style="padding:10px;text-align:center;color:#6c757d">${latest?.repairDate || '-'}</td>
      </tr>`;
    }).join('')}</tbody>
  </table>`;
}

// ---- FILTER ----
window.filterPeriod = function(p, btn) {
  currentFilter = p; currentPage = 1;
  document.querySelectorAll('.btn-filter').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  const titles = { all:'æ‰€æœ‰ç¶­ä¿®ç´€éŒ„', today:'ä»Šæ—¥ç¶­ä¿®ç´€éŒ„', week:'æœ¬é€±ç¶­ä¿®ç´€éŒ„', month:'æœ¬æœˆç¶­ä¿®ç´€éŒ„', year:'å¹´åº¦ç¶­ä¿®ç´€éŒ„', custom:'è‡ªè¨‚å€é–“' };
  document.getElementById('periodTitle').textContent = titles[p];
  document.getElementById('dateRangeRow').style.display = p === 'custom' ? 'flex' : 'none';
  if (p === 'custom') {
    const now = new Date();
    document.getElementById('startDate').value = `${now.getFullYear()}-${pad(now.getMonth()+1)}-01`;
    document.getElementById('endDate').value = today();
  }
  renderRecords();
};

window.filterStatus = function(s, card) {
  statusFilter = s; currentPage = 1;
  document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
  card.classList.add('active');
  renderRecords();
};

window.onSearch = function() { currentPage = 1; renderRecords(); };

function getFiltered() {
  const now = new Date();
  const todayD = new Date(now.getFullYear(), now.getMonth(), now.getDate());
  let list = allRecords.filter(r => {
    const rd = new Date(r.repairDate);
    if (currentFilter === 'all') return true; // é¡¯ç¤ºæ‰€æœ‰ç´€éŒ„
    if (currentFilter === 'today') return rd >= todayD;
    if (currentFilter === 'week') { const w = new Date(todayD); w.setDate(w.getDate()-7); return rd >= w; }
    if (currentFilter === 'month') { const m = new Date(todayD); m.setMonth(m.getMonth()-1); return rd >= m; }
    if (currentFilter === 'year') { const y = new Date(todayD); y.setFullYear(y.getFullYear()-1); return rd >= y; }
    if (currentFilter === 'custom') {
      const s = document.getElementById('startDate').value;
      const e = document.getElementById('endDate').value;
      if (s && e) { const end = new Date(e); end.setHours(23,59,59); return rd >= new Date(s) && rd <= end; }
    }
    return true;
  });
  if (statusFilter !== 'all') list = list.filter(r => r.status === statusFilter);
  const q = (document.getElementById('searchInput')?.value || '').toLowerCase();
  if (q) list = list.filter(r =>
    (r.customerName||'').toLowerCase().includes(q) ||
    (r.repairItem||'').toLowerCase().includes(q) ||
    (r.technician||'').toLowerCase().includes(q) ||
    (r.status||'').toLowerCase().includes(q) ||
    (r.notes||'').toLowerCase().includes(q)
  );
  return list.sort((a,b) => new Date(b.repairDate) - new Date(a.repairDate));
}

// ---- RENDER RECORDS ----
function renderRecords() {
  const list = getFiltered();
  updateStats(list);
  const total = list.length;
  const pages = Math.ceil(total / PER_PAGE);
  if (currentPage > pages && pages > 0) currentPage = 1;
  const slice = list.slice((currentPage-1)*PER_PAGE, currentPage*PER_PAGE);
  document.getElementById('recordCount').textContent = `å…± ${total} ç­†`;
  const el = document.getElementById('recordsList');
  
  // ç§»é™¤è¼‰å…¥ç‹€æ…‹ï¼Œé¡¯ç¤ºå¯¦éš›å…§å®¹
  if (!slice.length) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><p>ç›®å‰æ²’æœ‰ç¶­ä¿®ç´€éŒ„</p><p style="color:#6c757d;font-size:13px;margin-top:8px">é»æ“Šå³ä¸Šæ–¹ã€Œâ• æ–°å¢è¨˜éŒ„ã€é–‹å§‹ä½¿ç”¨</p></div>';
  } else {
    el.innerHTML = slice.map(r => recordHTML(r)).join('');
  }
  renderPagination(pages, total);
}

function recordHTML(r) {
  const key = r._key;
  const custName = esc(r.customerName);
  const itemName = esc(r.repairItem);
  
  const photos = r.photos ? Object.values(r.photos).map(p =>
    `<img class="record-photo" src="${p}" onclick="openLightbox('${p}')" alt="ç¶­ä¿®ç…§ç‰‡">`
  ).join('') : '';
  
  return `
  <div class="record-item">
    <div class="record-grid">
      <div class="record-field">
        <div class="label">å®¢æˆ¶åç¨±</div>
        <div class="value link" onclick="showHistory('customer','${custName}')">${r.customerName}</div>
      </div>
      <div class="record-field">
        <div class="label">ç¶­ä¿®é …ç›®</div>
        <div class="value link" onclick="showHistory('item','${itemName}')">${r.repairItem}</div>
      </div>
      <div class="record-field">
        <div class="label">ç¶­ä¿®äººå“¡</div>
        <div class="value">${r.technician}</div>
      </div>
      <div class="record-field">
        <div class="label">ç¶­ä¿®æ—¥æœŸ</div>
        <div class="value">${fmtDate(r.repairDate)}</div>
      </div>
      <div class="record-field">
        <div class="label">ç‹€æ…‹</div>
        <div class="value"><span class="status-badge ${badgeClass(r.status)}">${r.status}</span></div>
      </div>
      <div class="record-actions">
        <button class="btn btn-success btn-sm" onclick="openEditModal('${key}')">âœï¸</button>
        ${isAdmin ? `<button class="btn btn-danger btn-sm" onclick="deleteRecord('${key}')">ğŸ—‘ï¸</button>` : ''}
        ${isAdmin ? `<button class="btn btn-info btn-sm" onclick="exportSinglePDF('${key}')">ğŸ“„</button>` : ''}
      </div>
    </div>
    ${r.notes ? `<div class="record-meta">ğŸ“ ${r.notes}</div>` : ''}
    ${photos ? `<div class="record-photos">${photos}</div>` : ''}
    <div class="record-meta" style="margin-top:6px">
      <span>å»ºç«‹ï¼š${r.createdBy||'-'}</span>
      ${r.updatedBy ? `<span>æ›´æ–°ï¼š${r.updatedBy}</span>` : ''}
    </div>
  </div>`;
}

function updateStats(list) {
  document.getElementById('sTotal').textContent = allRecords.length;
  document.getElementById('sPending').textContent = allRecords.filter(r=>r.status==='å¾…è™•ç†').length;
  document.getElementById('sInProgress').textContent = allRecords.filter(r=>r.status==='é€²è¡Œä¸­').length;
  document.getElementById('sCompleted').textContent = allRecords.filter(r=>r.status==='å·²å®Œæˆ').length;
}

function renderPagination(pages, total) {
  const el = document.getElementById('paginationEl');
  if (pages <= 1) { el.style.display = 'none'; return; }
  el.style.display = 'flex';
  let h = `<button ${currentPage===1?'disabled':''} onclick="goPage(${currentPage-1})">ä¸Šä¸€é </button>`;
  const maxV = 5, start = Math.max(1, currentPage - 2), end = Math.min(pages, start + maxV - 1);
  if (start > 1) { h += `<button onclick="goPage(1)">1</button>`; if (start > 2) h += '<span>...</span>'; }
  for (let i = start; i <= end; i++) h += `<button class="${i===currentPage?'active':''}" onclick="goPage(${i})">${i}</button>`;
  if (end < pages) { if (end < pages-1) h += '<span>...</span>'; h += `<button onclick="goPage(${pages})">${pages}</button>`; }
  h += `<button ${currentPage===pages?'disabled':''} onclick="goPage(${currentPage+1})">ä¸‹ä¸€é </button>`;
  h += `<span class="pagination-info">å…± ${total} ç­†</span>`;
  el.innerHTML = h;
}

window.goPage = function(p) { currentPage = p; renderRecords(); window.scrollTo({top:0,behavior:'smooth'}); };

// ---- HISTORY VIEW ----
window.showHistory = function(type, value) {
  console.log('=== showHistory è¢«å‘¼å« ===', type, value);
  historyMode = { type, value };
  const label = type === 'customer' ? 'å®¢æˆ¶' : 'ç¶­ä¿®é …ç›®';
  document.getElementById('historyTitle').textContent = value;
  document.getElementById('historySubtitle').textContent = `${label}æ­·å²ç¶­ä¿®ç´€éŒ„`;
  document.getElementById('historyTableTitle').textContent = `${value} â€” æ‰€æœ‰ç´€éŒ„`;
  console.log('åˆ‡æ›åˆ°æ­·å²é é¢...');
  showTab('history');
  console.log('=== å·²åˆ‡æ›åˆ°æ­·å²é é¢ ===');
};

function renderHistory() {
  if (!historyMode) return;
  const { type, value } = historyMode;
  const list = allRecords
    .filter(r => type === 'customer' ? r.customerName === value : r.repairItem === value)
    .sort((a,b) => new Date(b.repairDate) - new Date(a.repairDate));
  const el = document.getElementById('historyList');
  if (!list.length) {
    el.innerHTML = '<div class="empty-state"><div class="empty-icon">ğŸ“‹</div><p>ç›®å‰æ²’æœ‰ç´€éŒ„</p></div>';
  } else {
    el.innerHTML = list.map(r => recordHTML(r)).join('');
  }
}

// ---- MODAL ----
window.openAddModal = function() {
  editKey = null; pendingPhotos = [];
  document.getElementById('modalTitle').textContent = 'æ–°å¢ç¶­ä¿®è¨˜éŒ„';
  document.getElementById('saveBtn').textContent = 'å„²å­˜';
  document.querySelector('#recordModal form').reset();
  document.getElementById('f_date').value = today();
  document.getElementById('photoPreview').innerHTML = '';
  
  // å–æ¶ˆæ‰€æœ‰å‹¾é¸
  document.querySelectorAll('input[name="repairItems"]').forEach(cb => cb.checked = false);
  document.getElementById('customItemCheck').checked = false;
  document.getElementById('customItem').style.display = 'none';
  document.getElementById('customItem').value = '';
  
  document.getElementById('recordModal').classList.add('active');
};

window.openEditModal = function(key) {
  console.log('=== openEditModal è¢«å‘¼å« ===', key);
  const r = allRecords.find(x => x._key === key);
  if (!r) {
    console.error('æ‰¾ä¸åˆ°ç´€éŒ„:', key);
    alert('æ‰¾ä¸åˆ°ç´€éŒ„ï¼');
    return;
  }
  console.log('æ‰¾åˆ°ç´€éŒ„:', r);
  editKey = key; pendingPhotos = [];
  document.getElementById('modalTitle').textContent = 'ç·¨è¼¯ç¶­ä¿®è¨˜éŒ„';
  document.getElementById('saveBtn').textContent = 'æ›´æ–°';
  document.getElementById('f_customer').value = r.customerName;
  document.getElementById('f_technician').value = r.technician;
  document.getElementById('f_date').value = r.repairDate;
  document.getElementById('f_status').value = r.status;
  document.getElementById('f_notes').value = r.notes || '';
  
  // è™•ç†ç¶­ä¿®é …ç›®ï¼ˆè¤‡é¸ï¼‰
  const items = r.repairItem.split('ã€');
  const predefined = ['å°é”é€†è®Šå™¨æ•…éšœ','æ–°æœ›é€†è®Šå™¨æ•…éšœ','å¤ç‘ç“¦ç‰¹é€†è®Šå™¨æ•…éšœ','äºåŠ›é€†è®Šå™¨æ•…éšœ','ç›ˆæ­£é€†è®Šå™¨æ•…éšœ','ç§‘é¢¨é€†è®Šå™¨æ•…éšœ','è¯ç‚ºé€†è®Šå™¨æ•…éšœ','å¤ªé™½èƒ½æ¿ç ´æ','é›»è·¯æª¢ä¿®','ç³»çµ±æ¸…æ½”ä¿é¤Š','ç›£æ§ç³»çµ±ç•°å¸¸','ä¸‰æƒŸç›£æ§æ•¸æ“šæ©Ÿç•°å¸¸','ç¶²è·¯è²»æœªç¹³','é…é›»ç®±ç¶­ä¿®','ä¿éšªçµ²ç†”æ–·','çªæ³¢ä¿è­·å™¨æ•…éšœ','ç«¯å­å°æ•…éšœ','æ”¯æ¶çµæ§‹æª¢æŸ¥','æ¥åœ°ç³»çµ±æª¢æ¸¬','ç·šè·¯è€åŒ–æ›´æ›'];
  
  // å…ˆå–æ¶ˆæ‰€æœ‰å‹¾é¸
  document.querySelectorAll('input[name="repairItems"]').forEach(cb => cb.checked = false);
  document.getElementById('customItemCheck').checked = false;
  document.getElementById('customItem').style.display = 'none';
  document.getElementById('customItem').value = '';
  
  // å‹¾é¸å°æ‡‰é …ç›®
  items.forEach(item => {
    if (predefined.includes(item)) {
      const cb = document.querySelector(`input[name="repairItems"][value="${item}"]`);
      if (cb) cb.checked = true;
    } else {
      // è‡ªè¨‚é …ç›®
      document.getElementById('customItemCheck').checked = true;
      document.getElementById('customItem').style.display = 'block';
      document.getElementById('customItem').value = item;
    }
  });
  
  document.getElementById('photoPreview').innerHTML = r.photos
    ? Object.values(r.photos).map(p => `<div class="photo-preview"><img src="${p}"><button class="remove-photo" type="button">Ã—</button></div>`).join('') : '';
  
  console.log('é–‹å•Ÿ Modal...');
  document.getElementById('recordModal').classList.add('active');
  console.log('=== Modal å·²é–‹å•Ÿ ===');
};

window.closeModal = function() {
  document.getElementById('recordModal').classList.remove('active');
  editKey = null; pendingPhotos = [];
};

// ---- PHOTOS ----
window.handlePhotos = function(input) {
  const files = Array.from(input.files);
  files.forEach(file => {
    const reader = new FileReader();
    reader.onload = e => {
      pendingPhotos.push(e.target.result);
      const grid = document.getElementById('photoPreview');
      const div = document.createElement('div');
      div.className = 'photo-preview';
      const idx = pendingPhotos.length - 1;
      div.innerHTML = `<img src="${e.target.result}"><button class="remove-photo" type="button" onclick="removePhoto(${idx},this)">Ã—</button>`;
      grid.appendChild(div);
    };
    reader.readAsDataURL(file);
  });
};

window.removePhoto = function(idx, btn) {
  pendingPhotos.splice(idx, 1);
  btn.parentElement.remove();
};

async function uploadPhotos(recordKey) {
  if (!pendingPhotos.length) return {};
  const urls = {};
  for (let i = 0; i < pendingPhotos.length; i++) {
    const photoRef = sRef(storage, `workspaces/${ws}/photos/${recordKey}/${Date.now()}_${i}.jpg`);
    await uploadString(photoRef, pendingPhotos[i], 'data_url');
    urls[`p${i}`] = await getDownloadURL(photoRef);
  }
  return urls;
}

// ---- SAVE RECORD ----
window.saveRecord = async function(e) {
  e.preventDefault();
  syncStatus('syncing');
  try {
    // å–å¾—è¤‡é¸çš„ç¶­ä¿®é …ç›®
    const checkedItems = Array.from(document.querySelectorAll('input[name="repairItems"]:checked'))
      .map(cb => cb.value);
    
    // å¦‚æœæœ‰å‹¾é¸ã€Œå…¶ä»–ã€
    const customCheck = document.getElementById('customItemCheck');
    if (customCheck.checked) {
      const customValue = document.getElementById('customItem').value.trim();
      if (customValue) {
        checkedItems.push(customValue);
      }
    }
    
    if (checkedItems.length === 0) {
      alert('è«‹è‡³å°‘é¸æ“‡ä¸€å€‹ç¶­ä¿®é …ç›®');
      syncStatus('online');
      return;
    }
    
    const itemValue = checkedItems.join('ã€');
    
    const data = {
      customerName: document.getElementById('f_customer').value,
      repairItem: itemValue,
      technician: document.getElementById('f_technician').value,
      repairDate: document.getElementById('f_date').value,
      status: document.getElementById('f_status').value,
      notes: document.getElementById('f_notes').value,
      updatedBy: user,
      updatedAt: serverTimestamp()
    };
    const key = editKey || push(dbRef).key;
    const photoUrls = await uploadPhotos(key);
    if (Object.keys(photoUrls).length) data.photos = photoUrls;

    if (editKey) {
      const existing = allRecords.find(r => r._key === editKey);
      if (existing?.photos) data.photos = { ...existing.photos, ...data.photos };
    } else {
      data.createdBy = user;
      data.createdAt = serverTimestamp();
    }
    await set(ref(db, `workspaces/${ws}/records/${key}`), data);
    syncStatus('online');
    closeModal();
  } catch (err) {
    console.error(err);
    syncStatus('offline', 'å„²å­˜å¤±æ•—');
    alert('å„²å­˜å¤±æ•—ï¼š' + err.message);
  }
};

// ---- DELETE ----
window.deleteRecord = async function(key) {
  console.log('=== deleteRecord è¢«å‘¼å« ===', key);
  if (!isAdmin) { 
    console.log('éç®¡ç†å“¡ï¼Œç„¡æ³•åˆªé™¤');
    alert('åƒ…ç®¡ç†å“¡å¯ä»¥åˆªé™¤ç´€éŒ„'); 
    return; 
  }
  if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ')) {
    console.log('ä½¿ç”¨è€…å–æ¶ˆåˆªé™¤');
    return;
  }
  console.log('é–‹å§‹åˆªé™¤ç´€éŒ„...');
  syncStatus('syncing');
  try {
    await remove(ref(db, `workspaces/${ws}/records/${key}`));
    console.log('åˆªé™¤æˆåŠŸ');
    syncStatus('online');
  } catch (err) {
    console.error('åˆªé™¤å¤±æ•—:', err);
    syncStatus('offline', 'åˆªé™¤å¤±æ•—');
    alert('åˆªé™¤å¤±æ•—ï¼š' + err.message);
  }
};

// ---- KPI ----
function renderKPI() {
  const total = allRecords.length;
  const completed = allRecords.filter(r => r.status === 'å·²å®Œæˆ').length;
  const pending = allRecords.filter(r => r.status === 'å¾…è™•ç†').length;
  const inprogress = allRecords.filter(r => r.status === 'é€²è¡Œä¸­').length;
  const rate = total ? Math.round(completed / total * 100) : 0;

  // æœˆä»½åˆ†ä½ˆ
  const monthly = {};
  allRecords.forEach(r => {
    const m = r.repairDate?.substring(0,7) || 'æœªçŸ¥';
    monthly[m] = (monthly[m] || 0) + 1;
  });
  const months = Object.keys(monthly).sort().slice(-6);
  const maxM = Math.max(...months.map(m => monthly[m]), 1);

  // æŠ€å¸«æ’è¡Œ
  const techMap = {};
  allRecords.forEach(r => { techMap[r.technician] = (techMap[r.technician]||0)+1; });
  const topTechs = Object.entries(techMap).sort((a,b)=>b[1]-a[1]).slice(0,5);

  // å¸¸è¦‹æ•…éšœ
  const itemMap = {};
  allRecords.forEach(r => { itemMap[r.repairItem] = (itemMap[r.repairItem]||0)+1; });
  const topItems = Object.entries(itemMap).sort((a,b)=>b[1]-a[1]).slice(0,5);

  // å®¢æˆ¶æ’è¡Œ
  const custMap = {};
  allRecords.forEach(r => { custMap[r.customerName] = (custMap[r.customerName]||0)+1; });
  const topCusts = Object.entries(custMap).sort((a,b)=>b[1]-a[1]).slice(0,5);

  document.getElementById('kpiGrid').innerHTML = `
    <div class="kpi-card"><h3>ç¸½ç¶­ä¿®ä»¶æ•¸</h3><div class="kpi-value">${total}</div><div class="kpi-sub">å…¨éƒ¨ç´€éŒ„</div></div>
    <div class="kpi-card"><h3>å®Œæˆç‡</h3><div class="kpi-value">${rate}%</div><div class="kpi-sub">å·²å®Œæˆ ${completed} ä»¶</div><div class="kpi-bar"><div class="kpi-bar-fill" style="width:${rate}%"></div></div></div>
    <div class="kpi-card"><h3>å¾…è™•ç†</h3><div class="kpi-value" style="color:#856404">${pending}</div><div class="kpi-sub">éœ€è¦è·Ÿé€²</div></div>
    <div class="kpi-card"><h3>é€²è¡Œä¸­</h3><div class="kpi-value" style="color:#004085">${inprogress}</div><div class="kpi-sub">æ–½å·¥ä¸­</div></div>
  `;

  document.getElementById('kpiCharts').innerHTML = `
    <div class="chart-section">
      <h3>ğŸ“… è¿‘ 6 å€‹æœˆç¶­ä¿®è¶¨å‹¢</h3>
      <div class="bar-chart">
        ${months.map(m => `
          <div class="bar-item">
            <div class="bar" style="height:${monthly[m]/maxM*120}px" data-value="${monthly[m]}ä»¶"></div>
            <div class="bar-label">${m.substring(5)}æœˆ</div>
          </div>`).join('')}
      </div>
    </div>
    <div class="chart-section">
      <h3>ğŸ”§ æŠ€å¸«ç¶­ä¿®ä»¶æ•¸ TOP 5</h3>
      <ul class="top-list">
        ${topTechs.map(([n,c],i)=>`<li><span class="rank">${i+1}</span><span class="name">${n}</span><span class="count">${c} ä»¶</span></li>`).join('')}
      </ul>
    </div>
    <div class="chart-section">
      <h3>âš¡ å¸¸è¦‹æ•…éšœ TOP 5</h3>
      <ul class="top-list">
        ${topItems.map(([n,c],i)=>`<li><span class="rank">${i+1}</span><span class="name">${n}</span><span class="count">${c} ä»¶</span></li>`).join('')}
      </ul>
    </div>
    <div class="chart-section">
      <h3>ğŸ¢ ç¶­ä¿®æ¬¡æ•¸æœ€å¤šå®¢æˆ¶ TOP 5</h3>
      <ul class="top-list">
        ${topCusts.map(([n,c],i)=>`<li><span class="rank">${i+1}</span><span class="name">${n}</span><span class="count">${c} ä»¶</span></li>`).join('')}
      </ul>
    </div>
  `;
}

// ---- PDF ----
window.exportSinglePDF = function(key) {
  const r = allRecords.find(x => x._key === key);
  if (!r) return;
  
  const html = `
    <div style="font-family: Microsoft JhengHei, Arial, sans-serif; padding: 40px; max-width: 800px;">
      <h1 style="text-align: center; color: #667eea; margin-bottom: 30px;">ç¶­ä¿®å ±å‘Š</h1>
      <table style="width: 100%; border-collapse: collapse;">
        <tr style="border-bottom: 1px solid #ddd;"><td style="padding: 12px; font-weight: bold; width: 150px;">å®¢æˆ¶åç¨±</td><td style="padding: 12px;">${r.customerName}</td></tr>
        <tr style="border-bottom: 1px solid #ddd;"><td style="padding: 12px; font-weight: bold;">ç¶­ä¿®é …ç›®</td><td style="padding: 12px;">${r.repairItem}</td></tr>
        <tr style="border-bottom: 1px solid #ddd;"><td style="padding: 12px; font-weight: bold;">ç¶­ä¿®äººå“¡</td><td style="padding: 12px;">${r.technician}</td></tr>
        <tr style="border-bottom: 1px solid #ddd;"><td style="padding: 12px; font-weight: bold;">ç¶­ä¿®æ—¥æœŸ</td><td style="padding: 12px;">${r.repairDate}</td></tr>
        <tr style="border-bottom: 1px solid #ddd;"><td style="padding: 12px; font-weight: bold;">ç‹€æ…‹</td><td style="padding: 12px;">${r.status}</td></tr>
        <tr style="border-bottom: 1px solid #ddd;"><td style="padding: 12px; font-weight: bold;">å‚™è¨»</td><td style="padding: 12px;">${r.notes || '-'}</td></tr>
        <tr style="border-bottom: 1px solid #ddd;"><td style="padding: 12px; font-weight: bold;">å»ºç«‹è€…</td><td style="padding: 12px;">${r.createdBy || '-'}</td></tr>
        <tr><td style="padding: 12px; font-weight: bold;">å»ºç«‹æ™‚é–“</td><td style="padding: 12px;">${new Date().toLocaleDateString('zh-TW')}</td></tr>
      </table>
    </div>
  `;
  
  const el = document.createElement('div');
  el.innerHTML = html;
  document.body.appendChild(el);
  
  html2pdf().from(el).set({
    margin: 10,
    filename: `ç¶­ä¿®å ±å‘Š_${r.customerName}_${r.repairDate}.pdf`,
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  }).save().then(() => {
    document.body.removeChild(el);
  });
};

window.exportKpiPDF = function() {
  const now = new Date().toLocaleDateString('zh-TW');
  const total = allRecords.length;
  const done = allRecords.filter(r => r.status === 'å·²å®Œæˆ').length;
  const wait = allRecords.filter(r => r.status === 'å¾…è™•ç†').length;
  const rate = total ? Math.round(done / total * 100) : 0;

  const tM = {};
  allRecords.forEach(r => { tM[r.technician] = (tM[r.technician] || 0) + 1; });
  const topT = Object.entries(tM).sort((a, b) => b[1] - a[1]).slice(0, 5);

  const iM = {};
  allRecords.forEach(r => { iM[r.repairItem] = (iM[r.repairItem] || 0) + 1; });
  const topI = Object.entries(iM).sort((a, b) => b[1] - a[1]).slice(0, 5);

  const html = `
    <div style="font-family: Microsoft JhengHei, Arial, sans-serif; padding: 40px; max-width: 800px;">
      <h1 style="text-align: center; color: #667eea; margin-bottom: 10px;">KPI çµ±è¨ˆå ±å‘Š</h1>
      <p style="text-align: center; color: #666; margin-bottom: 30px;">å·¥ä½œå€ï¼š${ws} | ç”¢ç”Ÿæ—¥æœŸï¼š${now}</p>
      
      <h2 style="color: #667eea; margin-top: 30px; margin-bottom: 15px; font-size: 18px;">æ•´é«”çµ±è¨ˆ</h2>
      <table style="width: 100%; border-collapse: collapse; margin-bottom: 30px;">
        <tr style="border-bottom: 1px solid #ddd;"><td style="padding: 10px;">ç¸½ç¶­ä¿®ä»¶æ•¸</td><td style="padding: 10px; font-weight: bold;">${total}</td></tr>
        <tr style="border-bottom: 1px solid #ddd;"><td style="padding: 10px;">å®Œæˆç‡</td><td style="padding: 10px; font-weight: bold;">${rate}%</td></tr>
        <tr style="border-bottom: 1px solid #ddd;"><td style="padding: 10px;">å·²å®Œæˆ</td><td style="padding: 10px; font-weight: bold;">${done}</td></tr>
        <tr><td style="padding: 10px;">å¾…è™•ç†</td><td style="padding: 10px; font-weight: bold;">${wait}</td></tr>
      </table>
      
      <h2 style="color: #667eea; margin-top: 30px; margin-bottom: 15px; font-size: 18px;">æŠ€å¸«ç¶­ä¿®ä»¶æ•¸ TOP 5</h2>
      <ol style="line-height: 2;">
        ${topT.map(([n, c]) => `<li>${n}ï¼š${c} ä»¶</li>`).join('')}
      </ol>
      
      <h2 style="color: #667eea; margin-top: 30px; margin-bottom: 15px; font-size: 18px;">å¸¸è¦‹æ•…éšœ TOP 5</h2>
      <ol style="line-height: 2;">
        ${topI.map(([n, c]) => `<li>${n}ï¼š${c} ä»¶</li>`).join('')}
      </ol>
    </div>
  `;
  
  const el = document.createElement('div');
  el.innerHTML = html;
  document.body.appendChild(el);
  
  html2pdf().from(el).set({
    margin: 10,
    filename: `KPIå ±å‘Š_${ws}_${now}.pdf`,
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  }).save().then(() => {
    document.body.removeChild(el);
  });
};

window.exportHistoryPDF = function() {
  if (!historyMode) return;
  const { type, value } = historyMode;
  const list = allRecords.filter(r => type === 'customer' ? r.customerName === value : r.repairItem === value)
    .sort((a, b) => new Date(b.repairDate) - new Date(a.repairDate));
  
  const html = `
    <div style="font-family: Microsoft JhengHei, Arial, sans-serif; padding: 40px; max-width: 800px;">
      <h1 style="text-align: center; color: #667eea; margin-bottom: 10px;">${value}</h1>
      <p style="text-align: center; color: #666; margin-bottom: 30px;">æ­·å²ç¶­ä¿®ç´€éŒ„ â€” å…± ${list.length} ç­†</p>
      
      ${list.map((r, i) => `
        <div style="border-bottom: 1px solid #ddd; padding: 15px 0;">
          <p style="margin: 5px 0;"><strong>${i+1}. ${r.repairDate}</strong> - ${r.repairItem} [${r.status}]</p>
          <p style="margin: 5px 0; color: #666;">æŠ€å¸«ï¼š${r.technician} | å‚™è¨»ï¼š${r.notes||'-'}</p>
        </div>
      `).join('')}
    </div>
  `;
  
  const el = document.createElement('div');
  el.innerHTML = html;
  document.body.appendChild(el);
  
  html2pdf().from(el).set({
    margin: 10,
    filename: `æ­·å²ç´€éŒ„_${value}.pdf`,
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  }).save().then(() => {
    document.body.removeChild(el);
  });
};
window.exportCSV = function() {
  if (!allRecords.length) { alert('æ²’æœ‰è³‡æ–™'); return; }
  const headers = ['å®¢æˆ¶åç¨±','ç¶­ä¿®é …ç›®','ç¶­ä¿®äººå“¡','ç¶­ä¿®æ—¥æœŸ','ç‹€æ…‹','å‚™è¨»','å»ºç«‹è€…'];
  const rows = allRecords.map(r => [r.customerName,r.repairItem,r.technician,r.repairDate,r.status,r.notes||'',r.createdBy||''].map(v=>`"${v}"`).join(','));
  const csv = '\uFEFF' + [headers.join(','), ...rows].join('\n');
  const a = document.createElement('a');
  a.href = URL.createObjectURL(new Blob([csv], { type:'text/csv;charset=utf-8' }));
  a.download = `ç¶­ä¿®ç´€éŒ„_${ws}_${today()}.csv`;
  a.click();
};

// ---- LIGHTBOX ----
window.openLightbox = function(src) {
  document.getElementById('lightboxImg').src = src;
  document.getElementById('lightbox').classList.add('active');
};
window.closeLightbox = function() { document.getElementById('lightbox').classList.remove('active'); };

// ---- AUTOCOMPLETE ----
function updateAutocomplete() {
  const customers = [...new Set(allRecords.map(r=>r.customerName))];
  const items = [...new Set(allRecords.map(r=>r.repairItem))];
  document.getElementById('customerList').innerHTML = customers.map(c=>`<option value="${c}">`).join('');
  document.getElementById('itemList').innerHTML = items.map(i=>`<option value="${i}">`).join('');
}

// ---- UTILS ----
function today() { return new Date().toISOString().split('T')[0]; }
function pad(n) { return String(n).padStart(2,'0'); }
function fmtDate(d) { if (!d) return '-'; const dt = new Date(d); return `${dt.getFullYear()}/${pad(dt.getMonth()+1)}/${pad(dt.getDate())}`; }
function esc(s) { return (s||'').replace(/'/g,"\\'"); }
function badgeClass(s) { return s==='å·²å®Œæˆ'?'badge-completed':s==='é€²è¡Œä¸­'?'badge-inprogress':'badge-pending'; }

// â”€â”€ åŒ¯å…¥ CSV â”€â”€
window.openImportModal = function() {
  document.getElementById('importModal').classList.add('active');
};

window.closeImportModal = function() {
  document.getElementById('importModal').classList.remove('active');
  document.getElementById('csvFile').value = '';
};

window.doImportCSV = async function() {
  const fileInput = document.getElementById('csvFile');
  if (!fileInput.files.length) {
    alert('è«‹é¸æ“‡ CSV æª”æ¡ˆ');
    return;
  }
  
  const file = fileInput.files[0];
  const reader = new FileReader();
  
  reader.onload = async function(e) {
    try {
      syncStatus('syncing', 'åŒ¯å…¥ä¸­...');
      const csv = e.target.result;
      const lines = csv.trim().split('\n');
      
      if (lines.length < 2) {
        alert('CSV æª”æ¡ˆæ ¼å¼éŒ¯èª¤');
        syncStatus('offline', 'åŒ¯å…¥å¤±æ•—');
        return;
      }
      
      // è·³éæ¨™é¡Œåˆ—
      const dataLines = lines.slice(1);
      let successCount = 0;
      let failCount = 0;
      
      for (const line of dataLines) {
        try {
          // è™•ç† CSV æ¬„ä½ï¼ˆè€ƒæ…®å¼•è™ŸåŒ…è£¹çš„æƒ…æ³ï¼‰
          const parts = line.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
          const fields = parts.map(p => p.replace(/^"|"$/g, '').trim());
          
          if (fields.length < 5) {
            failCount++;
            continue;
          }
          
          const newRecordRef = push(dbRef);
          await set(newRecordRef, {
            id: Date.now() + successCount,
            customerName: fields[0] || '',
            repairItem: fields[1] || '',
            technician: fields[2] || '',
            repairDate: fields[3] || '',
            status: fields[4] || 'å¾…è™•ç†',
            notes: fields[5] || '',
            createdBy: user + ' (åŒ¯å…¥)',
            createdAt: serverTimestamp()
          });
          
          successCount++;
          // åŠ å…¥å°å»¶é²é¿å… Firebase é™åˆ¶
          await new Promise(resolve => setTimeout(resolve, 50));
        } catch (err) {
          console.error('åŒ¯å…¥å–®ç­†å¤±æ•—:', err);
          failCount++;
        }
      }
      
      syncStatus('online', 'å·²åŒæ­¥');
      closeImportModal();
      alert(`âœ… åŒ¯å…¥å®Œæˆï¼\n\næˆåŠŸï¼š${successCount} ç­†\nå¤±æ•—ï¼š${failCount} ç­†`);
      
    } catch (err) {
      syncStatus('offline', 'åŒ¯å…¥å¤±æ•—');
      alert('åŒ¯å…¥å¤±æ•—ï¼š' + err.message);
    }
  };
  
  reader.readAsText(file, 'UTF-8');
};

// â”€â”€ è¨ˆç®—æ­·å²è¨˜éŒ„ â”€â”€
let calcHistory = [];
let lastPRCalc = null;
let lastRACalc = null;

// â”€â”€ PR å€¼è¨ˆç®— â”€â”€
window.calculatePR = function() {
  const actual = parseFloat(document.getElementById('pr_actual').value);
  const irradiation = parseFloat(document.getElementById('pr_irradiation').value);
  const capacity = parseFloat(document.getElementById('pr_capacity').value);
  const hours = parseFloat(document.getElementById('pr_hours').value);
  
  if (!actual || !irradiation || !capacity || !hours) {
    alert('è«‹å¡«å¯«æ‰€æœ‰æ¬„ä½');
    return;
  }
  
  // PR = å¯¦éš›ç™¼é›»é‡ Ã· (æ—¥ç…§å¼·åº¦ Ã— ç³»çµ±å®¹é‡ Ã— æ™‚æ•¸) Ã— 100%
  // æ—¥ç…§å¼·åº¦éœ€è¦å¾ W/mÂ² è½‰æ›ç‚º kW/mÂ²
  const irradiationKW = irradiation / 1000;
  const theoreticalEnergy = irradiationKW * capacity * hours;
  const pr = (actual / theoreticalEnergy) * 100;
  const prRounded = Math.round(pr * 100) / 100;
  
  document.getElementById('prValue').textContent = prRounded + '%';
  document.getElementById('prDetails').textContent = `ç†è«–ç™¼é›»é‡ï¼š${theoreticalEnergy.toFixed(2)} kWh`;
  
  let status = '', color = '';
  if (pr >= 80) {
    status = 'âœ… å„ªè‰¯ - ç³»çµ±é‹ä½œè‰¯å¥½';
    color = '#28a745';
  } else if (pr >= 70) {
    status = 'ğŸ‘ è‰¯å¥½ - é‹ä½œæ­£å¸¸';
    color = '#17a2b8';
  } else if (pr >= 60) {
    status = 'âš ï¸ æ™®é€š - å»ºè­°æª¢æŸ¥';
    color = '#ffc107';
  } else {
    status = 'âŒ éœ€æ”¹å–„ - è«‹ç›¡å¿«æª¢ä¿®';
    color = '#dc3545';
  }
  
  document.getElementById('prStatus').textContent = status;
  document.getElementById('prValue').style.color = color;
  document.getElementById('prResult').style.display = 'block';
  
  // å„²å­˜è¨ˆç®—çµæœ
  lastPRCalc = {
    actual,
    irradiation,
    capacity,
    hours,
    theoretical: theoreticalEnergy,
    pr: prRounded,
    status
  };
  
  // è¨˜éŒ„åˆ°æ­·å²
  addCalcHistory('PRå€¼', `${prRounded}%`, {
    å¯¦éš›ç™¼é›»é‡: actual + ' kWh',
    æ—¥ç…§å¼·åº¦: irradiation + ' W/mÂ²',
    ç³»çµ±å®¹é‡: capacity + ' kWp',
    æ—¥ç…§æ™‚æ•¸: hours + ' å°æ™‚',
    ç†è«–ç™¼é›»é‡: theoreticalEnergy.toFixed(2) + ' kWh'
  });
};

// â”€â”€ RA å€¼è¨ˆç®— â”€â”€
window.calculateRA = function() {
  const measured = parseFloat(document.getElementById('ra_measured').value);
  const rated = parseFloat(document.getElementById('ra_rated').value);
  const irradiance = parseFloat(document.getElementById('ra_irradiance').value);
  const temperature = parseFloat(document.getElementById('ra_temperature').value);
  
  if (!measured || !rated) {
    alert('è«‹è‡³å°‘å¡«å¯«å¯¦æ¸¬ä¸²åˆ—åŠŸç‡å’Œé¡å®šè£ç½®å®¹é‡');
    return;
  }
  
  // RA = (å¯¦æ¸¬ä¸²åˆ—åŠŸç‡ Ã· é¡å®šè£ç½®å®¹é‡) Ã— 100%
  const ra = (measured / rated) * 100;
  const raRounded = Math.round(ra * 100) / 100;
  
  document.getElementById('raValue').textContent = raRounded + '%';
  
  // é¡¯ç¤ºé‡æ¸¬æ¢ä»¶
  let conditions = `é‡æ¸¬æ¢ä»¶ï¼šå¯¦æ¸¬åŠŸç‡ ${measured} kW / é¡å®šå®¹é‡ ${rated} kWp`;
  if (irradiance) {
    conditions += ` | æ—¥ç…§ ${irradiance} W/mÂ²`;
  }
  if (temperature) {
    conditions += ` | æº«åº¦ ${temperature}Â°C`;
  }
  document.getElementById('raConditions').textContent = conditions;
  
  let color = '';
  if (ra >= 90) {
    color = '#28a745';
  } else if (ra >= 80) {
    color = '#17a2b8';
  } else if (ra >= 70) {
    color = '#ffc107';
  } else {
    color = '#dc3545';
  }
  
  document.getElementById('raValue').style.color = color;
  document.getElementById('raResult').style.display = 'block';
  
  // å„²å­˜è¨ˆç®—çµæœ
  lastRACalc = {
    measured,
    rated,
    irradiance: irradiance || null,
    temperature: temperature || null,
    ra: raRounded
  };
  
  // è¨˜éŒ„åˆ°æ­·å²
  const details = {
    å¯¦æ¸¬ä¸²åˆ—åŠŸç‡: measured + ' kW',
    é¡å®šè£ç½®å®¹é‡: rated + ' kWp'
  };
  if (irradiance) details['æ—¥ç…§å¼·åº¦'] = irradiance + ' W/mÂ²';
  if (temperature) details['æ¨¡çµ„æº«åº¦'] = temperature + 'Â°C';
  
  addCalcHistory('RAå€¼', `${raRounded}%`, details);
};

// â”€â”€ PDF åŒ¯å‡º â”€â”€
window.exportCalcPDF = function(type) {
  const now = new Date().toLocaleDateString('zh-TW');
  let html = '';
  
  if (type === 'PR' && lastPRCalc) {
    const c = lastPRCalc;
    html = `
      <div style="font-family: Microsoft JhengHei, Arial, sans-serif; padding: 40px; max-width: 800px;">
        <h1 style="text-align: center; color: #667eea; margin-bottom: 10px;">PR å€¼è¨ˆç®—å ±å‘Š</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">å·¥ä½œå€ï¼š${ws} | ç”¢ç”Ÿæ—¥æœŸï¼š${now}</p>
        
        <h2 style="color: #667eea; margin-top: 30px; margin-bottom: 15px; font-size: 18px;">è¨ˆç®—çµæœ</h2>
        <div style="background: #f0f2ff; padding: 20px; border-radius: 8px; border-left: 4px solid #667eea; margin-bottom: 20px;">
          <div style="font-size: 36px; font-weight: bold; color: #667eea; margin-bottom: 10px;">PR å€¼ï¼š${c.pr}%</div>
          <div style="font-size: 14px; color: #666;">${c.status}</div>
        </div>
        
        <h2 style="color: #667eea; margin-top: 30px; margin-bottom: 15px; font-size: 18px;">è¨ˆç®—åƒæ•¸</h2>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
          <tr style="border-bottom: 1px solid #ddd;"><td style="padding: 10px;">å¯¦éš›ç™¼é›»é‡</td><td style="padding: 10px; font-weight: bold;">${c.actual} kWh</td></tr>
          <tr style="border-bottom: 1px solid #ddd;"><td style="padding: 10px;">æ—¥ç…§å¼·åº¦</td><td style="padding: 10px; font-weight: bold;">${c.irradiation} W/mÂ²</td></tr>
          <tr style="border-bottom: 1px solid #ddd;"><td style="padding: 10px;">ç³»çµ±å®¹é‡</td><td style="padding: 10px; font-weight: bold;">${c.capacity} kWp</td></tr>
          <tr style="border-bottom: 1px solid #ddd;"><td style="padding: 10px;">æ—¥ç…§æ™‚æ•¸</td><td style="padding: 10px; font-weight: bold;">${c.hours} å°æ™‚</td></tr>
          <tr><td style="padding: 10px;">ç†è«–ç™¼é›»é‡</td><td style="padding: 10px; font-weight: bold;">${c.theoretical.toFixed(2)} kWh</td></tr>
        </table>
        
        <h2 style="color: #667eea; margin-top: 30px; margin-bottom: 15px; font-size: 18px;">è¨ˆç®—å…¬å¼</h2>
        <p style="color: #666; font-size: 14px;">PR å€¼ = å¯¦éš›ç™¼é›»é‡ Ã· (æ—¥ç…§å¼·åº¦ Ã— ç³»çµ±å®¹é‡ Ã— æ™‚æ•¸) Ã— 100%</p>
        <p style="color: #666; font-size: 14px;">PR å€¼ = ${c.actual} Ã· (${c.irradiation/1000} Ã— ${c.capacity} Ã— ${c.hours}) Ã— 100% = ${c.pr}%</p>
      </div>
    `;
  } else if (type === 'RA' && lastRACalc) {
    const c = lastRACalc;
    let conditionsHTML = `
      <tr style="border-bottom: 1px solid #ddd;"><td style="padding: 10px;">å¯¦æ¸¬ä¸²åˆ—åŠŸç‡</td><td style="padding: 10px; font-weight: bold;">${c.measured} kW</td></tr>
      <tr style="border-bottom: 1px solid #ddd;"><td style="padding: 10px;">é¡å®šè£ç½®å®¹é‡</td><td style="padding: 10px; font-weight: bold;">${c.rated} kWp</td></tr>
    `;
    if (c.irradiance) {
      conditionsHTML += `<tr style="border-bottom: 1px solid #ddd;"><td style="padding: 10px;">é‡æ¸¬æ™‚æ—¥ç…§å¼·åº¦</td><td style="padding: 10px; font-weight: bold;">${c.irradiance} W/mÂ²</td></tr>`;
    }
    if (c.temperature) {
      conditionsHTML += `<tr><td style="padding: 10px;">é‡æ¸¬æ™‚æ¨¡çµ„æº«åº¦</td><td style="padding: 10px; font-weight: bold;">${c.temperature}Â°C</td></tr>`;
    }
    
    html = `
      <div style="font-family: Microsoft JhengHei, Arial, sans-serif; padding: 40px; max-width: 800px;">
        <h1 style="text-align: center; color: #28a745; margin-bottom: 10px;">RA å€¼è¨ˆç®—å ±å‘Š</h1>
        <p style="text-align: center; color: #666; margin-bottom: 30px;">å·¥ä½œå€ï¼š${ws} | ç”¢ç”Ÿæ—¥æœŸï¼š${now}</p>
        
        <h2 style="color: #28a745; margin-top: 30px; margin-bottom: 15px; font-size: 18px;">è¨ˆç®—çµæœ</h2>
        <div style="background: #f0fff4; padding: 20px; border-radius: 8px; border-left: 4px solid #28a745; margin-bottom: 20px;">
          <div style="font-size: 36px; font-weight: bold; color: #28a745; margin-bottom: 10px;">RA å€¼ï¼š${c.ra}%</div>
          <div style="font-size: 14px; color: #666;">å¯¦æ¸¬åŠŸç‡ ${c.measured} kW / é¡å®šå®¹é‡ ${c.rated} kWp</div>
        </div>
        
        <h2 style="color: #28a745; margin-top: 30px; margin-bottom: 15px; font-size: 18px;">é‡æ¸¬æ¢ä»¶èˆ‡åƒæ•¸</h2>
        <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
          ${conditionsHTML}
        </table>
        
        <h2 style="color: #28a745; margin-top: 30px; margin-bottom: 15px; font-size: 18px;">è¨ˆç®—å…¬å¼</h2>
        <p style="color: #666; font-size: 14px;">RA å€¼ = (å¯¦æ¸¬ä¸²åˆ—åŠŸç‡ Ã· é¡å®šè£ç½®å®¹é‡) Ã— 100%</p>
        <p style="color: #666; font-size: 14px;">RA å€¼ = ${c.measured} Ã· ${c.rated} Ã— 100% = ${c.ra}%</p>
        
        <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
          <p style="font-size: 12px; color: #666; margin: 0;"><strong>è¨»ï¼š</strong>RA å€¼åæ˜ å¤ªé™½èƒ½ç³»çµ±åœ¨ç‰¹å®šç’°å¢ƒæ¢ä»¶ä¸‹çš„å¯¦éš›é‹ä½œæ•ˆèƒ½ã€‚æ¨™æº–æ¸¬è©¦æ¢ä»¶(STC)ç‚º 25Â°Cã€1000 W/mÂ²ã€‚</p>
        </div>
      </div>
    `;
  } else {
    alert('æ²’æœ‰è¨ˆç®—çµæœå¯ä»¥åŒ¯å‡º');
    return;
  }
  
  const el = document.createElement('div');
  el.innerHTML = html;
  document.body.appendChild(el);
  
  html2pdf().from(el).set({
    margin: 10,
    filename: `${type}å€¼è¨ˆç®—å ±å‘Š_${ws}_${now}.pdf`,
    html2canvas: { scale: 2 },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  }).save().then(() => {
    document.body.removeChild(el);
  });
};

function addCalcHistory(type, result, details) {
  const now = new Date();
  const timeStr = `${now.getFullYear()}/${pad(now.getMonth()+1)}/${pad(now.getDate())} ${pad(now.getHours())}:${pad(now.getMinutes())}`;
  
  calcHistory.unshift({
    type,
    result,
    details,
    time: timeStr
  });
  
  // åªä¿ç•™æœ€è¿‘ 10 ç­†
  if (calcHistory.length > 10) calcHistory = calcHistory.slice(0, 10);
  
  // æ›´æ–°é¡¯ç¤º
  renderCalcHistory();
}

function renderCalcHistory() {
  const el = document.getElementById('calcHistory');
  if (!calcHistory.length) {
    el.innerHTML = '<p style="color:#6c757d;font-size:13px">å°šç„¡è¨ˆç®—ç´€éŒ„</p>';
    return;
  }
  
  el.innerHTML = calcHistory.map((h, i) => `
    <div style="padding:12px;border-bottom:1px solid #e9ecef;${i===0?'background:#f8f9fa;':''}">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">
        <strong style="color:#667eea">${h.type}: ${h.result}</strong>
        <span style="font-size:11px;color:#6c757d">${h.time}</span>
      </div>
      <div style="font-size:12px;color:#6c757d">
        ${Object.entries(h.details).map(([k,v])=>`${k}: ${v}`).join(' | ')}
      </div>
    </div>
  `).join('');
}

// ---- INIT ----
// è¨­å®šè‡ªè¨‚ç¶­ä¿®é …ç›®checkboxç›£è½
document.addEventListener('DOMContentLoaded', function() {
  const customCheck = document.getElementById('customItemCheck');
  if (customCheck) {
    customCheck.addEventListener('change', function() {
      const customInput = document.getElementById('customItem');
      if (customInput) {
        customInput.style.display = this.checked ? 'block' : 'none';
        if (!this.checked) customInput.value = '';
      }
    });
  }
});

// é é¢è¼‰å…¥æ™‚æª¢æŸ¥æ˜¯å¦æœ‰å„²å­˜çš„ç™»å…¥è³‡è¨Š
const savedWs = localStorage.getItem('ws');
const savedUser = localStorage.getItem('user');
const savedAdmin = localStorage.getItem('isAdmin');

if (savedWs && savedUser) {
  // è‡ªå‹•æ¢å¾©ç™»å…¥ç‹€æ…‹
  ws = savedWs;
  user = savedUser;
  isAdmin = savedAdmin === '1';
  
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('mainApp').style.display = 'block';
  document.getElementById('wsDisplay').textContent = ws;
  document.getElementById('userDisplay').textContent = user;
  
  applyAdminUI();
  initDB();
} else {
  // å¡«å…¥ä¹‹å‰çš„å·¥ä½œå€å’Œä½¿ç”¨è€…åç¨±ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
  if (savedWs) document.getElementById('workspaceId').value = savedWs;
  if (savedUser) document.getElementById('userName').value = savedUser;
}
</script>
</body>
</html>
