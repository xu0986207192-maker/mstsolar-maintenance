<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="theme-color" content="#667eea">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="å…‰é›»ç¶­ä¿®">
<title>å¤ªé™½å…‰é›»ç¶­ä¿®ç®¡ç†ç³»çµ± v3</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Microsoft JhengHei','PingFang TC',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px;}
.page{max-width:1200px;margin:0 auto;background:white;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden;}
.header{background:linear-gradient(135deg,#667eea,#764ba2);color:white;padding:22px 28px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:10px;}
.header h1{font-size:22px;margin-bottom:4px;}.header p{opacity:.85;font-size:12px;}
.header-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;}
.badge{padding:5px 12px;border-radius:20px;font-size:12px;font-weight:700;}
.badge-admin{background:#ffc107;color:#212529;}.badge-member{background:rgba(255,255,255,.2);color:white;}
.sync-pill{background:rgba(255,255,255,.2);padding:6px 13px;border-radius:20px;font-size:12px;display:flex;align-items:center;gap:6px;}
.dot{width:8px;height:8px;border-radius:50%;background:#4ade80;animation:pulse 2s infinite;}
.dot.sync{background:#fbbf24;}.dot.off{background:#ef4444;animation:none;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.5;}}
.btn{padding:9px 16px;border:none;border-radius:8px;cursor:pointer;font-size:13px;font-weight:600;transition:all .25s;font-family:inherit;}
.btn:hover{transform:translateY(-1px);}
.btn-primary{background:#667eea;color:white;}.btn-primary:hover{background:#5568d3;box-shadow:0 4px 12px rgba(102,126,234,.4);}
.btn-success{background:#28a745;color:white;}.btn-success:hover{background:#218838;}
.btn-danger{background:#dc3545;color:white;}.btn-danger:hover{background:#c82333;}
.btn-warning{background:#ffc107;color:#212529;}
.btn-info{background:#17a2b8;color:white;}
.btn-gray{background:#6c757d;color:white;}
.btn-ghost{background:rgba(255,255,255,.15);color:white;border:1px solid rgba(255,255,255,.3);}.btn-ghost:hover{background:rgba(255,255,255,.25);}
.btn-sm{padding:5px 11px;font-size:12px;}.btn-lg{padding:13px 24px;font-size:15px;width:100%;}
.nav{display:flex;background:#f8f9fa;border-bottom:2px solid #e9ecef;overflow-x:auto;}
.nav-item{padding:13px 20px;cursor:pointer;font-weight:600;font-size:13px;color:#6c757d;border-bottom:3px solid transparent;white-space:nowrap;transition:all .2s;}
.nav-item:hover{color:#667eea;}.nav-item.on{color:#667eea;border-bottom-color:#667eea;background:white;}
.content{padding:24px;}
.form-group{margin-bottom:16px;}
.lbl{display:block;margin-bottom:6px;color:#495057;font-weight:600;font-size:13px;}
.inp,.sel,.ta{width:100%;padding:10px 12px;border:2px solid #dee2e6;border-radius:8px;font-size:13px;font-family:inherit;transition:border-color .2s;}
.inp:focus,.sel:focus,.ta:focus{outline:none;border-color:#667eea;}
.ta{resize:vertical;min-height:75px;}
.row2{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.controls{padding:18px 24px;background:#f8f9fa;border-bottom:2px solid #e9ecef;}
.ctrl-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center;margin-bottom:10px;}
.ctrl-row:last-child{margin-bottom:0;}
.btn-filter{background:white;color:#495057;border:2px solid #dee2e6;padding:8px 15px;font-size:13px;}
.btn-filter.on{background:#667eea;color:white;border-color:#667eea;}
.search-wrap{flex:1;min-width:200px;}
.search-wrap input{width:100%;padding:9px 14px;border:2px solid #dee2e6;border-radius:8px;font-size:13px;font-family:inherit;}
.search-wrap input:focus{outline:none;border-color:#667eea;}
.stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:14px;margin-bottom:22px;}
.stat{padding:16px;border-radius:12px;text-align:center;cursor:pointer;transition:all .2s;}
.stat:hover{transform:translateY(-2px);box-shadow:0 4px 14px rgba(0,0,0,.12);}
.stat.on{outline:3px solid #667eea;}
.stat.s-all{background:linear-gradient(135deg,#f5f7fa,#c3cfe2);}
.stat.s-wait{background:linear-gradient(135deg,#ffecd2,#fcb69f);}
.stat.s-wip{background:linear-gradient(135deg,#cce5ff,#99caff);}
.stat.s-done{background:linear-gradient(135deg,#a8edea,#fed6e3);}
.stat-n{font-size:26px;font-weight:bold;color:#2d3748;margin-bottom:3px;}
.stat-l{font-size:12px;color:#4a5568;}
.tbl{border-radius:12px;overflow:hidden;border:1px solid #e9ecef;}
.tbl-head{background:#f8f9fa;padding:13px 17px;border-bottom:2px solid #dee2e6;font-weight:600;color:#495057;display:flex;justify-content:space-between;align-items:center;font-size:13px;}
.rec{padding:16px;border-bottom:1px solid #e9ecef;transition:background .15s;}
.rec:hover{background:#f8f9fa;}.rec:last-child{border-bottom:none;}
.rec-grid{display:grid;grid-template-columns:1.8fr 1.8fr 1.2fr 1.2fr 1fr auto;gap:11px;align-items:center;}
.fl{font-size:13px;}.fl .fl-lbl{color:#6c757d;font-size:11px;margin-bottom:2px;}
.fl .fl-val{color:#2d3748;font-weight:500;}
.fl .fl-val.link{color:#667eea;cursor:pointer;text-decoration:underline;}
.fl .fl-val.link:hover{color:#5568d3;}
.actions{display:flex;gap:5px;flex-wrap:wrap;}
.bs{display:inline-block;padding:4px 10px;border-radius:20px;font-size:11px;font-weight:600;}
.bs-wait{background:#fff3cd;color:#856404;}
.bs-wip{background:#cce5ff;color:#004085;}
.bs-done{background:#d4edda;color:#155724;}
.rec-meta{margin-top:7px;display:flex;gap:14px;font-size:11px;color:#6c757d;flex-wrap:wrap;}
.rec-photos{margin-top:7px;display:flex;gap:7px;flex-wrap:wrap;}
.rec-photo{width:55px;height:55px;object-fit:cover;border-radius:6px;cursor:pointer;border:2px solid #e9ecef;}
.pages{display:flex;justify-content:center;align-items:center;gap:7px;padding:16px;flex-wrap:wrap;}
.pages button{padding:6px 13px;border:2px solid #667eea;background:white;color:#667eea;border-radius:6px;cursor:pointer;font-weight:600;font-size:12px;transition:all .2s;}
.pages button:hover:not(:disabled){background:#667eea;color:white;}
.pages button:disabled{opacity:.3;cursor:not-allowed;}
.pages button.on{background:#667eea;color:white;}
.pages-info{color:#6c757d;font-size:12px;}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.55);z-index:1000;align-items:center;justify-content:center;padding:16px;}
.modal.show{display:flex;}
.modal-box{background:white;border-radius:16px;width:100%;max-width:600px;max-height:92vh;overflow-y:auto;box-shadow:0 20px 60px rgba(0,0,0,.3);}
.modal-head{padding:20px 24px;border-bottom:2px solid #e9ecef;display:flex;justify-content:space-between;align-items:center;position:sticky;top:0;background:white;z-index:5;}
.modal-head h2{color:#2d3748;font-size:18px;}
.x-btn{background:none;border:none;font-size:24px;cursor:pointer;color:#6c757d;line-height:1;}
.modal-body{padding:22px;}
.form-actions{display:flex;gap:9px;justify-content:flex-end;margin-top:18px;}
.photo-drop{border:2px dashed #dee2e6;border-radius:8px;padding:22px;text-align:center;cursor:pointer;transition:all .2s;}
.photo-drop:hover{border-color:#667eea;background:#f0f2ff;}
.photo-grid{display:flex;gap:7px;flex-wrap:wrap;margin-top:9px;}
.photo-wrap{position:relative;width:75px;height:75px;}
.photo-wrap img{width:100%;height:100%;object-fit:cover;border-radius:6px;}
.rm-photo{position:absolute;top:-5px;right:-5px;background:#dc3545;color:white;border:none;border-radius:50%;width:19px;height:19px;font-size:11px;cursor:pointer;display:flex;align-items:center;justify-content:center;}
.hist-head{display:flex;align-items:center;gap:11px;margin-bottom:18px;flex-wrap:wrap;}
.back-btn{background:#f8f9fa;border:2px solid #dee2e6;color:#495057;padding:7px 14px;border-radius:8px;cursor:pointer;font-weight:600;font-size:13px;}
.back-btn:hover{background:#e9ecef;}
.kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:18px;margin-bottom:22px;}
.kpi-card{background:white;border-radius:12px;padding:18px;border:1px solid #e9ecef;box-shadow:0 2px 8px rgba(0,0,0,.05);}
.kpi-card h3{font-size:12px;color:#6c757d;margin-bottom:9px;text-transform:uppercase;letter-spacing:.5px;}
.kpi-val{font-size:28px;font-weight:bold;color:#2d3748;margin-bottom:4px;}
.kpi-sub{font-size:12px;color:#6c757d;}
.kpi-bar{background:#e9ecef;border-radius:10px;height:7px;margin-top:7px;}
.kpi-fill{background:#667eea;border-radius:10px;height:100%;transition:width .5s;}
.chart-box{background:white;border-radius:12px;padding:18px;border:1px solid #e9ecef;margin-bottom:18px;}
.chart-box h3{font-size:15px;font-weight:600;color:#2d3748;margin-bottom:13px;}
.bar-chart{display:flex;align-items:flex-end;gap:9px;height:150px;padding-bottom:22px;border-bottom:2px solid #e9ecef;}
.bar-item{flex:1;display:flex;flex-direction:column;align-items:center;gap:4px;}
.bar{width:100%;background:linear-gradient(135deg,#667eea,#764ba2);border-radius:5px 5px 0 0;min-height:3px;position:relative;cursor:pointer;}
.bar:hover::after{content:attr(data-v);position:absolute;top:-22px;left:50%;transform:translateX(-50%);background:#2d3748;color:white;padding:2px 7px;border-radius:4px;font-size:11px;white-space:nowrap;}
.bar-lbl{font-size:10px;color:#6c757d;text-align:center;}
.top-list{list-style:none;}
.top-list li{display:flex;justify-content:space-between;align-items:center;padding:9px 0;border-bottom:1px solid #e9ecef;font-size:13px;}
.top-list li:last-child{border-bottom:none;}
.rank{background:#667eea;color:white;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:bold;margin-right:9px;flex-shrink:0;}
.top-name{flex:1;color:#2d3748;}.top-count{font-weight:bold;color:#667eea;}
.card-section{border:1px solid #e9ecef;border-radius:12px;padding:22px;margin-bottom:18px;}
.card-section > h3{font-size:15px;font-weight:700;color:#2d3748;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid #e9ecef;}
.user-row{display:flex;justify-content:space-between;align-items:center;padding:11px 0;border-bottom:1px solid #e9ecef;font-size:13px;flex-wrap:wrap;gap:8px;}
.user-row:last-child{border-bottom:none;}
.user-info{display:flex;align-items:center;gap:9px;}
.user-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,#667eea,#764ba2);color:white;display:flex;align-items:center;justify-content:center;font-weight:bold;font-size:14px;flex-shrink:0;}
.user-name{font-weight:600;color:#2d3748;}.user-meta{font-size:11px;color:#6c757d;}
.ws-tag{display:inline-flex;align-items:center;gap:7px;background:#f8f9fa;border:1px solid #e9ecef;border-radius:8px;padding:9px 14px;margin:5px;font-size:13px;cursor:pointer;transition:all .2s;}
.ws-tag:hover{border-color:#667eea;color:#667eea;}
.ws-count{background:#667eea;color:white;border-radius:10px;padding:2px 8px;font-size:11px;font-weight:700;}
.danger-zone{border:2px solid #dc3545;border-radius:12px;padding:22px;}
.empty{text-align:center;padding:48px 20px;color:#6c757d;}
.empty-icon{font-size:50px;margin-bottom:13px;opacity:.3;}
.loading{text-align:center;padding:38px;}
.spin{border:4px solid #f3f3f3;border-top:4px solid #667eea;border-radius:50%;width:36px;height:36px;animation:spin 1s linear infinite;margin:0 auto 13px;}
@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
.lightbox{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.92);z-index:2000;align-items:center;justify-content:center;}
.lightbox.show{display:flex;}
.lightbox img{max-width:90%;max-height:90%;border-radius:8px;}
.lb-x{position:absolute;top:18px;right:22px;color:white;font-size:32px;cursor:pointer;}
.login-wrap{padding:48px 28px;text-align:center;max-width:420px;margin:0 auto;}
.login-wrap h2{color:#2d3748;margin-bottom:11px;font-size:21px;}
.login-wrap p{color:#6c757d;margin-bottom:26px;line-height:1.6;font-size:14px;}
.alert{padding:11px 16px;border-radius:8px;margin-bottom:16px;font-size:13px;}
.alert-ok{background:#d4edda;color:#155724;border:1px solid #c3e6cb;}
.alert-warn{background:#fff3cd;color:#856404;border:1px solid #ffeaa7;}
.alert-info{background:#cce5ff;color:#004085;border:1px solid #b8daff;}
.tab-switch{display:flex;margin-bottom:22px;border:2px solid #667eea;border-radius:10px;overflow:hidden;}
.tsw{flex:1;padding:10px;border:none;background:white;color:#667eea;cursor:pointer;font-weight:600;font-size:13px;font-family:inherit;transition:all .2s;}
.tsw.on{background:#667eea;color:white;}
@media(max-width:768px){
  .rec-grid{grid-template-columns:1fr;gap:7px;}
  .row2{grid-template-columns:1fr;}
  .header{flex-direction:column;}
  .kpi-grid{grid-template-columns:1fr 1fr;}
}
</style>
</head>
<body>

<!-- ç™»å…¥é  -->
<div id="loginPage" class="page">
  <div class="header"><div><h1>â˜€ï¸ å¤ªé™½å…‰é›»ç¶­ä¿®ç®¡ç†ç³»çµ±</h1><p>é›²ç«¯å³æ™‚åŒæ­¥ v3.0</p></div></div>
  <div class="login-wrap">
    <h2>ğŸ” ç™»å…¥ç³»çµ±</h2>
    <p>è«‹é¸æ“‡ç™»å…¥æ–¹å¼</p>
    <div class="tab-switch">
      <button class="tsw on" onclick="swLogin('member')">ğŸ‘¤ æˆå“¡ç™»å…¥</button>
      <button class="tsw" onclick="swLogin('admin')">ğŸ‘‘ ç®¡ç†å“¡ç™»å…¥</button>
    </div>
    <div id="memberForm">
      <div class="alert alert-info">è¼¸å…¥ç®¡ç†å“¡çµ¦ä½ çš„å¸³è™Ÿå’Œå¯†ç¢¼</div>
      <form onsubmit="doMemberLogin(event)">
        <div class="form-group" style="text-align:left"><label class="lbl">å¸³è™Ÿ</label><input type="text" class="inp" id="m_acc" required placeholder="ä¾‹å¦‚ï¼šzhang001"></div>
        <div class="form-group" style="text-align:left"><label class="lbl">å¯†ç¢¼</label><input type="password" class="inp" id="m_pw" required placeholder="è¼¸å…¥å¯†ç¢¼"></div>
        <button type="submit" class="btn btn-primary btn-lg">ç™»å…¥</button>
      </form>
    </div>
    <div id="adminForm" style="display:none">
      <div class="alert alert-warn">âš ï¸ ç®¡ç†å“¡å°ˆç”¨ç™»å…¥ï¼Œè«‹å¦¥å–„ä¿ç®¡å¯†ç¢¼</div>
      <form onsubmit="doAdminLogin(event)">
        <div class="form-group" style="text-align:left"><label class="lbl">ç®¡ç†å“¡å¯†ç¢¼</label><input type="password" class="inp" id="a_pw" required placeholder="è¼¸å…¥ç®¡ç†å“¡å¯†ç¢¼"></div>
        <button type="submit" class="btn btn-primary btn-lg">ç®¡ç†å“¡ç™»å…¥</button>
      </form>
      <p style="margin-top:12px;font-size:12px;color:#6c757d">é è¨­å¯†ç¢¼ï¼š<strong>admin1234</strong>ï¼ˆç™»å…¥å¾Œè«‹ç«‹å³æ›´æ”¹ï¼‰</p>
    </div>
  </div>
</div>

<!-- ä¸»é é¢ -->
<div id="mainPage" class="page" style="display:none">
  <div class="header">
    <div><h1>â˜€ï¸ å¤ªé™½å…‰é›»ç¶­ä¿®ç®¡ç†ç³»çµ±</h1><p>å·¥ä½œå€ï¼š<span id="wsLbl"></span> | <span id="meLbl"></span></p></div>
    <div class="header-right">
      <div class="sync-pill"><div class="dot" id="syncDot"></div><span id="syncTxt">é€£ç·šä¸­...</span></div>
      <span id="roleBadge" class="badge"></span>
      <button class="btn btn-ghost btn-sm" onclick="doLogout()">ç™»å‡º</button>
    </div>
  </div>
  <div class="nav">
    <div class="nav-item on" onclick="goTab('records')">ğŸ“‹ ç¶­ä¿®ç´€éŒ„</div>
    <div class="nav-item" id="nav-kpi" onclick="goTab('kpi')">ğŸ“Š KPI çµ±è¨ˆ</div>
    <div class="nav-item" id="nav-admin" style="display:none" onclick="goTab('admin')">âš™ï¸ ç®¡ç†å¾Œå°</div>
  </div>

  <!-- ç¶­ä¿®ç´€éŒ„ tab -->
  <div id="tab-records">
    <div class="controls">
      <div class="ctrl-row">
        <div style="display:flex;gap:7px;flex-wrap:wrap">
          <button class="btn btn-filter on" onclick="setPeriod('today',this)">ä»Šæ—¥</button>
          <button class="btn btn-filter" onclick="setPeriod('week',this)">æœ¬é€±</button>
          <button class="btn btn-filter" onclick="setPeriod('month',this)">æœ¬æœˆ</button>
          <button class="btn btn-filter" onclick="setPeriod('year',this)">å¹´åº¦</button>
          <button class="btn btn-filter" onclick="setPeriod('custom',this)">è‡ªè¨‚</button>
        </div>
        <div class="search-wrap"><input type="text" id="searchQ" placeholder="ğŸ” æœå°‹é—œéµå­—ï¼ˆå®¢æˆ¶/é …ç›®/äººå“¡/ç‹€æ…‹/å‚™è¨»ï¼‰..." oninput="doSearch()"></div>
        <button class="btn btn-info admin-btn" style="display:none" onclick="doExportCSV()">ğŸ“¥ åŒ¯å‡º</button>
        <button class="btn btn-primary" onclick="openAdd()">â• æ–°å¢è¨˜éŒ„</button>
      </div>
      <div id="customRow" style="display:none" class="ctrl-row">
        <label style="font-weight:600;color:#495057;font-size:13px">æ—¥æœŸå€é–“ï¼š</label>
        <input type="date" id="d_s" class="inp" style="width:auto;padding:8px" onchange="doRender()">
        <span style="color:#6c757d">è‡³</span>
        <input type="date" id="d_e" class="inp" style="width:auto;padding:8px" onchange="doRender()">
      </div>
    </div>
    <div class="content">
      <div class="stats">
        <div class="stat s-all on" onclick="setSF('all',this)"><div class="stat-n" id="s_all">0</div><div class="stat-l">ç¸½ç¶­ä¿®ç´€éŒ„</div></div>
        <div class="stat s-wait" onclick="setSF('å¾…è™•ç†',this)"><div class="stat-n" id="s_wait">0</div><div class="stat-l">å¾…è™•ç†</div></div>
        <div class="stat s-wip" onclick="setSF('é€²è¡Œä¸­',this)"><div class="stat-n" id="s_wip">0</div><div class="stat-l">é€²è¡Œä¸­</div></div>
        <div class="stat s-done" onclick="setSF('å·²å®Œæˆ',this)"><div class="stat-n" id="s_done">0</div><div class="stat-l">å·²å®Œæˆ</div></div>
      </div>
      <div class="tbl">
        <div class="tbl-head"><span id="periodLbl">æœ¬é€±ç¶­ä¿®ç´€éŒ„</span><span id="recCount" style="font-size:11px;font-weight:normal;color:#6c757d"></span></div>
        <div id="recList"><div class="loading"><div class="spin"></div><p>è¼‰å…¥è³‡æ–™ä¸­...</p></div></div>
        <div class="pages" id="pageEl" style="display:none"></div>
      </div>
    </div>
  </div>

  <!-- KPI tab -->
  <div id="tab-kpi" style="display:none">
    <div class="content">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:18px;flex-wrap:wrap;gap:10px">
        <h2 style="color:#2d3748;font-size:20px">ğŸ“Š KPI çµ±è¨ˆå ±è¡¨</h2>
        <button class="btn btn-primary" onclick="exportKpiPDF()">ğŸ“„ åŒ¯å‡º PDF</button>
      </div>
      <div class="kpi-grid" id="kpiGrid"></div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:18px" id="kpiCharts"></div>
    </div>
  </div>

  <!-- æ­·å² tab -->
  <div id="tab-history" style="display:none">
    <div class="content">
      <div class="hist-head">
        <button class="back-btn" onclick="goTab('records')">â† è¿”å›</button>
        <div><div style="font-size:18px;font-weight:bold;color:#2d3748" id="histTitle"></div><div style="font-size:13px;color:#6c757d;margin-top:2px" id="histSub"></div></div>
        <button class="btn btn-primary admin-btn" style="display:none;margin-left:auto" onclick="exportHistPDF()">ğŸ“„ åŒ¯å‡º PDF</button>
      </div>
      <div class="tbl"><div class="tbl-head"><span id="histTblTitle">æ­·å²ç´€éŒ„</span></div><div id="histList"></div></div>
    </div>
  </div>

  <!-- ç®¡ç†å¾Œå° tab -->
  <div id="tab-admin" style="display:none">
    <div class="content">
      <h2 style="color:#2d3748;font-size:20px;margin-bottom:20px">âš™ï¸ ç®¡ç†å¾Œå°</h2>

      <div class="card-section">
        <h3>ğŸŒ æ‰€æœ‰å·¥ä½œå€ç¸½è¦½</h3>
        <div id="allWs"><div class="loading"><div class="spin"></div><p>è¼‰å…¥ä¸­...</p></div></div>
      </div>

      <div class="card-section">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;padding-bottom:10px;border-bottom:1px solid #e9ecef">
          <h3 style="margin:0;padding:0;border:none">ğŸ‘¥ å¸³è™Ÿç®¡ç†</h3>
          <button class="btn btn-primary btn-sm" onclick="openAddUser()">â• æ–°å¢å¸³è™Ÿ</button>
        </div>
        <div id="userList"><div class="loading"><div class="spin"></div><p>è¼‰å…¥ä¸­...</p></div></div>
      </div>

      <div class="card-section">
        <h3>ğŸ”‘ æ›´æ”¹ç®¡ç†å“¡å¯†ç¢¼</h3>
        <div class="row2">
          <div class="form-group"><label class="lbl">æ–°å¯†ç¢¼ï¼ˆè‡³å°‘6ç¢¼ï¼‰</label><input type="password" class="inp" id="new_pw" placeholder="è¼¸å…¥æ–°å¯†ç¢¼"></div>
          <div class="form-group"><label class="lbl">ç¢ºèªå¯†ç¢¼</label><input type="password" class="inp" id="cfm_pw" placeholder="å†æ¬¡ç¢ºèª"></div>
        </div>
        <button class="btn btn-primary" onclick="changeAdminPw()">æ›´æ–°å¯†ç¢¼</button>
      </div>

      <div class="danger-zone">
        <h3 style="color:#dc3545;margin-bottom:9px;font-size:15px">âš ï¸ å±éšªå€åŸŸ</h3>
        <p style="color:#6c757d;font-size:13px;margin-bottom:14px">ä»¥ä¸‹æ“ä½œä¸å¯å¾©åŸ</p>
        <button class="btn btn-danger" onclick="clearWs()">ğŸ—‘ï¸ æ¸…é™¤æŒ‡å®šå·¥ä½œå€æ‰€æœ‰ç´€éŒ„</button>
      </div>
    </div>
  </div>
</div>

<!-- è¨˜éŒ„ Modal -->
<div class="modal" id="recModal">
  <div class="modal-box">
    <div class="modal-head"><h2 id="recMTitle">æ–°å¢ç¶­ä¿®è¨˜éŒ„</h2><button class="x-btn" onclick="closeRec()">&times;</button></div>
    <div class="modal-body">
      <form onsubmit="saveRec(event)">
        <div class="row2">
          <div class="form-group"><label class="lbl">å®¢æˆ¶åç¨± *</label><input type="text" class="inp" id="f_cust" required list="custList"><datalist id="custList"></datalist></div>
          <div class="form-group"><label class="lbl">ç¶­ä¿®äººå“¡ *</label><input type="text" class="inp" id="f_tech" required></div>
        </div>
        <div class="form-group"><label class="lbl">ç¶­ä¿®é …ç›® *</label><input type="text" class="inp" id="f_item" required list="itemList"><datalist id="itemList"></datalist></div>
        <div class="row2">
          <div class="form-group"><label class="lbl">ç¶­ä¿®æ—¥æœŸ *</label><input type="date" class="inp" id="f_date" required></div>
          <div class="form-group"><label class="lbl">ç‹€æ…‹ *</label><select class="sel" id="f_stat"><option value="å¾…è™•ç†">å¾…è™•ç†</option><option value="é€²è¡Œä¸­">é€²è¡Œä¸­</option><option value="å·²å®Œæˆ">å·²å®Œæˆ</option></select></div>
        </div>
        <div class="form-group"><label class="lbl">å‚™è¨»</label><textarea class="ta" id="f_notes" placeholder="è©³ç´°èªªæ˜ã€é›¶ä»¶ã€è²»ç”¨..."></textarea></div>
        <div class="form-group">
          <label class="lbl">ğŸ“¸ ä¸Šå‚³ç…§ç‰‡</label>
          <div class="photo-drop" onclick="document.getElementById('photoFile').click()"><div style="font-size:26px;margin-bottom:7px">ğŸ“·</div><div style="color:#6c757d;font-size:13px">é»æ“Šé¸æ“‡ç…§ç‰‡ï¼ˆå¯å¤šå¼µï¼‰</div></div>
          <input type="file" id="photoFile" accept="image/*" multiple style="display:none" onchange="handlePics(this)">
          <div class="photo-grid" id="photoGrid"></div>
        </div>
        <div class="form-actions">
          <button type="button" class="btn btn-gray" onclick="closeRec()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary" id="saveRecBtn">å„²å­˜</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- å¸³è™Ÿ Modal -->
<div class="modal" id="userModal">
  <div class="modal-box" style="max-width:440px">
    <div class="modal-head"><h2>æ–°å¢æˆå“¡å¸³è™Ÿ</h2><button class="x-btn" onclick="closeUser()">&times;</button></div>
    <div class="modal-body">
      <div class="alert alert-info">å»ºç«‹å¾Œè«‹å°‡å¸³è™Ÿå¯†ç¢¼å‘ŠçŸ¥æˆå“¡</div>
      <form onsubmit="saveUser(event)">
        <div class="form-group"><label class="lbl">å¸³è™Ÿï¼ˆå·¥è™Ÿï¼‰*</label><input type="text" class="inp" id="u_acc" required placeholder="ä¾‹å¦‚ï¼šzhang001"></div>
        <div class="form-group"><label class="lbl">é¡¯ç¤ºåç¨± *</label><input type="text" class="inp" id="u_name" required placeholder="ä¾‹å¦‚ï¼šå¼µå¿—æ˜"></div>
        <div class="form-group"><label class="lbl">å¯†ç¢¼ *ï¼ˆè‡³å°‘6ç¢¼ï¼‰</label><input type="password" class="inp" id="u_pw" required minlength="6" placeholder="è‡³å°‘6ç¢¼"></div>
        <div class="form-group"><label class="lbl">æŒ‡å®šå·¥ä½œå€</label><input type="text" class="inp" id="u_ws" placeholder="ç•™ç©ºå‰‡ä½¿ç”¨ç®¡ç†å“¡ç›®å‰å·¥ä½œå€"><small style="color:#6c757d;font-size:12px">ç›¸åŒå·¥ä½œå€çš„æˆå“¡å¯ä»¥çœ‹åˆ°å½¼æ­¤çš„ç´€éŒ„</small></div>
        <div class="form-actions">
          <button type="button" class="btn btn-gray" onclick="closeUser()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-primary">å»ºç«‹å¸³è™Ÿ</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- ç‡ˆç®± -->
<div class="lightbox" id="lb" onclick="closeLb()"><span class="lb-x">&times;</span><img id="lbImg" src="" alt=""></div>

<script type="module">
import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
import { getDatabase, ref, set, push, remove, onValue, get, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';
import { getStorage, ref as sr, uploadString, getDownloadURL } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js';

const app = initializeApp({
  apiKey:"AIzaSyCbz3jN6PBRcEGcuknZEs2Sp0VOIfPWhr8",
  authDomain:"mstsolar-maintenance.firebaseapp.com",
  databaseURL:"https://mstsolar-maintenance-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"mstsolar-maintenance",
  storageBucket:"mstsolar-maintenance.firebasestorage.app",
  messagingSenderId:"1061682843376",
  appId:"1:1061682843376:web:8c9255f9e390bfc64efc35"
});
const db = getDatabase(app);
const stg = getStorage(app);
const ADMIN_KEY = '__admin__';

let recs=[], ws='', me='', role='member';
let period='week', sf='all', page=1;
let editKey=null, pics=[], histMode=null;
const PER=10;

// â”€â”€â”€ SYNC UI â”€â”€â”€
function ss(s,t){
  const d=document.getElementById('syncDot'),tx=document.getElementById('syncTxt');
  if(!d||!tx)return;
  d.className='dot'+(s==='sync'?' sync':s==='off'?' off':'');
  tx.textContent=t||(s==='sync'?'åŒæ­¥ä¸­...':s==='off'?'é›¢ç·š':'å·²åŒæ­¥');
}

// â”€â”€â”€ LOGIN SWITCH â”€â”€â”€
window.swLogin = function(mode){
  document.querySelectorAll('.tsw').forEach((b,i)=>b.classList.toggle('on',(i===0&&mode==='member')||(i===1&&mode==='admin')));
  document.getElementById('memberForm').style.display=mode==='member'?'block':'none';
  document.getElementById('adminForm').style.display=mode==='admin'?'block':'none';
};

window.doAdminLogin = async function(e){
  e.preventDefault();
  const pw=document.getElementById('a_pw').value;
  try{
    const snap=await get(ref(db,`${ADMIN_KEY}/adminPass`));
    const saved=snap.val()||'admin1234';
    if(pw!==saved){alert('ç®¡ç†å“¡å¯†ç¢¼éŒ¯èª¤');return;}
    role='admin'; me='ç®¡ç†å“¡'; ws='__all__';
    saveSess(); startApp();
  }catch(err){alert('ç™»å…¥å¤±æ•—ï¼š'+err.message);}
};

window.doMemberLogin = async function(e){
  e.preventDefault();
  const acc=document.getElementById('m_acc').value.trim();
  const pw=document.getElementById('m_pw').value;
  try{
    const snap=await get(ref(db,`${ADMIN_KEY}/users/${acc}`));
    const u=snap.val();
    if(!u){alert('å¸³è™Ÿä¸å­˜åœ¨ï¼Œè«‹è¯çµ¡ç®¡ç†å“¡æ–°å¢å¸³è™Ÿ');return;}
    if(u.password!==pw){alert('å¯†ç¢¼éŒ¯èª¤');return;}
    role='member'; me=u.name||acc; ws=u.workspace||acc;
    saveSess(); startApp();
  }catch(err){alert('ç™»å…¥å¤±æ•—ï¼š'+err.message);}
};

function saveSess(){localStorage.setItem('v3',JSON.stringify({ws,me,role}));}
function loadSess(){try{const s=JSON.parse(localStorage.getItem('v3'));if(s&&s.ws){ws=s.ws;me=s.me;role=s.role;return true;}}catch{}return false;}

window.doLogout = function(){
  if(!confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ'))return;
  localStorage.removeItem('v3'); location.reload();
};

// â”€â”€â”€ START APP â”€â”€â”€
function startApp(){
  document.getElementById('loginPage').style.display='none';
  document.getElementById('mainPage').style.display='block';
  document.getElementById('wsLbl').textContent=role==='admin'?'å…¨éƒ¨å·¥ä½œå€':ws;
  document.getElementById('meLbl').textContent=me;
  const rb=document.getElementById('roleBadge');
  rb.className='badge '+(role==='admin'?'badge-admin':'badge-member');
  rb.textContent=role==='admin'?'ğŸ‘‘ ç®¡ç†å“¡':'ğŸ‘¤ '+me;
  if(role==='admin'){
    document.getElementById('nav-admin').style.display='block';
    document.querySelectorAll('.admin-btn').forEach(b=>b.style.display='inline-flex');
  }
  document.getElementById('f_date').value=tod();
  initData();
}

// â”€â”€â”€ DATA INIT â”€â”€â”€
function initData(){
  ss('sync');
  if(role==='admin'){
    onValue(ref(db,'workspaces'),snap=>{
      recs=[];
      const d=snap.val()||{};
      Object.keys(d).forEach(w=>{
        const wr=d[w].records||{};
        Object.keys(wr).forEach(k=>recs.push({_key:k,_ws:w,...wr[k]}));
      });
      ss('online','å·²åŒæ­¥'); updateAC(); doRender();
      if(document.getElementById('tab-kpi').style.display!=='none') renderKPI();
      if(document.getElementById('tab-admin').style.display!=='none') renderAdmin();
    },err=>{ss('off','é€£ç·šå¤±æ•—');console.error(err);});
  }else{
    onValue(ref(db,`workspaces/${ws}/records`),snap=>{
      const d=snap.val()||{};
      recs=Object.keys(d).map(k=>({_key:k,_ws:ws,...d[k]}));
      ss('online','å·²åŒæ­¥'); updateAC(); doRender();
    },err=>{ss('off','é€£ç·šå¤±æ•—');console.error(err);});
  }
}

// â”€â”€â”€ TABS â”€â”€â”€
window.goTab = function(tab){
  ['records','kpi','history','admin'].forEach(t=>{
    const el=document.getElementById('tab-'+t);
    if(el)el.style.display='none';
  });
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('on'));
  document.getElementById('tab-'+tab).style.display='block';
  if(tab==='records') document.querySelectorAll('.nav-item')[0].classList.add('on');
  else if(tab==='kpi'){
    if(role!=='admin'){alert('æ­¤åŠŸèƒ½åƒ…é™ç®¡ç†å“¡');goTab('records');return;}
    document.getElementById('nav-kpi').classList.add('on'); renderKPI();
  }else if(tab==='admin'){
    if(role!=='admin'){alert('æ­¤åŠŸèƒ½åƒ…é™ç®¡ç†å“¡');goTab('records');return;}
    document.getElementById('nav-admin').classList.add('on'); renderAdmin();
  }
};

// â”€â”€â”€ FILTERS â”€â”€â”€
window.setPeriod = function(p,btn){
  period=p; page=1;
  document.querySelectorAll('.btn-filter').forEach(b=>b.classList.remove('on'));
  btn.classList.add('on');
  const t={today:'ä»Šæ—¥',week:'æœ¬é€±',month:'æœ¬æœˆ',year:'å¹´åº¦',custom:'è‡ªè¨‚å€é–“'};
  document.getElementById('periodLbl').textContent=t[p]+'ç¶­ä¿®ç´€éŒ„';
  document.getElementById('customRow').style.display=p==='custom'?'flex':'none';
  if(p==='custom'){const n=new Date();document.getElementById('d_s').value=`${n.getFullYear()}-${pad(n.getMonth()+1)}-01`;document.getElementById('d_e').value=tod();}
  doRender();
};
window.setSF = function(s,card){sf=s;page=1;document.querySelectorAll('.stat').forEach(c=>c.classList.remove('on'));card.classList.add('on');doRender();};
window.doSearch = function(){page=1;doRender();};

function getFiltered(){
  const now=new Date(),td=new Date(now.getFullYear(),now.getMonth(),now.getDate());
  let list=recs.filter(r=>{
    const d=new Date(r.repairDate);
    if(period==='today')return d>=td;
    if(period==='week'){const w=new Date(td);w.setDate(w.getDate()-7);return d>=w;}
    if(period==='month'){const m=new Date(td);m.setMonth(m.getMonth()-1);return d>=m;}
    if(period==='year'){const y=new Date(td);y.setFullYear(y.getFullYear()-1);return d>=y;}
    if(period==='custom'){
      const s=document.getElementById('d_s').value,e=document.getElementById('d_e').value;
      if(s&&e){const en=new Date(e);en.setHours(23,59,59);return d>=new Date(s)&&d<=en;}
    }
    return true;
  });
  if(sf!=='all')list=list.filter(r=>r.status===sf);
  const q=(document.getElementById('searchQ')?.value||'').toLowerCase();
  if(q)list=list.filter(r=>['customerName','repairItem','technician','status','notes'].some(k=>(r[k]||'').toLowerCase().includes(q)));
  return list.sort((a,b)=>new Date(b.repairDate)-new Date(a.repairDate));
}

// â”€â”€â”€ RENDER â”€â”€â”€
function doRender(){
  const list=getFiltered();
  document.getElementById('s_all').textContent=recs.length;
  document.getElementById('s_wait').textContent=recs.filter(r=>r.status==='å¾…è™•ç†').length;
  document.getElementById('s_wip').textContent=recs.filter(r=>r.status==='é€²è¡Œä¸­').length;
  document.getElementById('s_done').textContent=recs.filter(r=>r.status==='å·²å®Œæˆ').length;
  const total=list.length,pages=Math.ceil(total/PER);
  if(page>pages)page=1;
  const sl=list.slice((page-1)*PER,page*PER);
  document.getElementById('recCount').textContent=`å…± ${total} ç­†`;
  const el=document.getElementById('recList');
  el.innerHTML=sl.length?sl.map(rHTML).join(''):'<div class="empty"><div class="empty-icon">ğŸ“‹</div><p>ç›®å‰æ²’æœ‰ç¶­ä¿®ç´€éŒ„</p></div>';
  renderPg(pages,total);
}
window.doRender=doRender;

function rHTML(r){
  const photos=r.photos?Object.values(r.photos).map(p=>`<img class="rec-photo" src="${p}" onclick="openLb('${p}')" alt="">`).join(''):'';
  const wsBadge=role==='admin'?`<span style="background:#e9ecef;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:8px">${r._ws||''}</span>`:'';
  return `<div class="rec">
    <div class="rec-grid">
      <div class="fl"><div class="fl-lbl">å®¢æˆ¶åç¨±</div><div class="fl-val link" onclick="showHist('customer','${esc(r.customerName)}')">${r.customerName}${wsBadge}</div></div>
      <div class="fl"><div class="fl-lbl">ç¶­ä¿®é …ç›®</div><div class="fl-val link" onclick="showHist('item','${esc(r.repairItem)}')">${r.repairItem}</div></div>
      <div class="fl"><div class="fl-lbl">ç¶­ä¿®äººå“¡</div><div class="fl-val">${r.technician}</div></div>
      <div class="fl"><div class="fl-lbl">ç¶­ä¿®æ—¥æœŸ</div><div class="fl-val">${fmtD(r.repairDate)}</div></div>
      <div class="fl"><div class="fl-lbl">ç‹€æ…‹</div><div class="fl-val"><span class="bs ${bc(r.status)}">${r.status}</span></div></div>
      <div class="actions">
        <button class="btn btn-success btn-sm" onclick="openEdit('${r._key}','${r._ws||ws}')">âœï¸</button>
        ${role==='admin'?`<button class="btn btn-danger btn-sm" onclick="delRec('${r._key}','${r._ws||ws}')">ğŸ—‘ï¸</button>
        <button class="btn btn-info btn-sm" onclick="exportOnePDF('${r._key}')">ğŸ“„</button>`:''}
      </div>
    </div>
    ${r.notes?`<div class="rec-meta">ğŸ“ ${r.notes}</div>`:''}
    ${photos?`<div class="rec-photos">${photos}</div>`:''}
    <div class="rec-meta"><span>å»ºç«‹ï¼š${r.createdBy||'-'}</span>${r.updatedBy?`<span>æ›´æ–°ï¼š${r.updatedBy}</span>`:''}</div>
  </div>`;
}

function renderPg(pages,total){
  const el=document.getElementById('pageEl');
  if(pages<=1){el.style.display='none';return;}
  el.style.display='flex';
  let h=`<button ${page===1?'disabled':''} onclick="goPg(${page-1})">ä¸Šä¸€é </button>`;
  const s=Math.max(1,page-2),e=Math.min(pages,s+4);
  if(s>1){h+=`<button onclick="goPg(1)">1</button>`;if(s>2)h+='<span>...</span>';}
  for(let i=s;i<=e;i++)h+=`<button class="${i===page?'on':''}" onclick="goPg(${i})">${i}</button>`;
  if(e<pages){if(e<pages-1)h+='<span>...</span>';h+=`<button onclick="goPg(${pages})">${pages}</button>`;}
  h+=`<button ${page===pages?'disabled':''} onclick="goPg(${page+1})">ä¸‹ä¸€é </button>`;
  h+=`<span class="pages-info">å…± ${total} ç­†</span>`;
  el.innerHTML=h;
}
window.goPg=function(p){page=p;doRender();window.scrollTo({top:0,behavior:'smooth'});};

// â”€â”€â”€ HISTORY â”€â”€â”€
window.showHist=function(type,value){
  histMode={type,value};
  document.getElementById('histTitle').textContent=value;
  document.getElementById('histSub').textContent=(type==='customer'?'å®¢æˆ¶':'ç¶­ä¿®é …ç›®')+'æ­·å²ç´€éŒ„';
  document.getElementById('histTblTitle').textContent=`${value} â€” æ‰€æœ‰ç´€éŒ„`;
  ['records','kpi','admin'].forEach(t=>{const el=document.getElementById('tab-'+t);if(el)el.style.display='none';});
  document.getElementById('tab-history').style.display='block';
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('on'));
  const list=recs.filter(r=>type==='customer'?r.customerName===value:r.repairItem===value).sort((a,b)=>new Date(b.repairDate)-new Date(a.repairDate));
  document.getElementById('histList').innerHTML=list.length?list.map(rHTML).join(''):'<div class="empty"><div class="empty-icon">ğŸ“‹</div><p>ç›®å‰æ²’æœ‰ç´€éŒ„</p></div>';
};

// â”€â”€â”€ RECORD MODAL â”€â”€â”€
window.openAdd=function(){
  editKey=null;pics=[];
  document.getElementById('recMTitle').textContent='æ–°å¢ç¶­ä¿®è¨˜éŒ„';
  document.getElementById('saveRecBtn').textContent='å„²å­˜';
  document.querySelector('#recModal form').reset();
  document.getElementById('f_date').value=tod();
  document.getElementById('photoGrid').innerHTML='';
  document.getElementById('recModal').classList.add('show');
};
window.openEdit=function(key,rws){
  const r=recs.find(x=>x._key===key);if(!r)return;
  editKey=key;pics=[];
  document.getElementById('recMTitle').textContent='ç·¨è¼¯ç¶­ä¿®è¨˜éŒ„';
  document.getElementById('saveRecBtn').textContent='æ›´æ–°';
  document.getElementById('f_cust').value=r.customerName;
  document.getElementById('f_item').value=r.repairItem;
  document.getElementById('f_tech').value=r.technician;
  document.getElementById('f_date').value=r.repairDate;
  document.getElementById('f_stat').value=r.status;
  document.getElementById('f_notes').value=r.notes||'';
  document.getElementById('photoGrid').innerHTML=r.photos?Object.values(r.photos).map(p=>`<div class="photo-wrap"><img src="${p}"><button class="rm-photo" type="button" onclick="this.parentElement.remove()">Ã—</button></div>`).join(''):'';
  document.getElementById('recModal').classList.add('show');
};
window.closeRec=function(){document.getElementById('recModal').classList.remove('show');editKey=null;pics=[];};

// â”€â”€â”€ PHOTOS â”€â”€â”€
window.handlePics=function(inp){
  Array.from(inp.files).forEach(f=>{
    const fr=new FileReader();
    fr.onload=ev=>{
      pics.push(ev.target.result);
      const div=document.createElement('div');div.className='photo-wrap';
      const idx=pics.length-1;
      div.innerHTML=`<img src="${ev.target.result}"><button class="rm-photo" type="button" onclick="pics.splice(${idx},1);this.parentElement.remove()">Ã—</button>`;
      document.getElementById('photoGrid').appendChild(div);
    };fr.readAsDataURL(f);
  });
};
async function upPics(key,wsT){
  if(!pics.length)return{};
  const urls={};
  for(let i=0;i<pics.length;i++){
    const r=sr(stg,`workspaces/${wsT}/photos/${key}/${Date.now()}_${i}.jpg`);
    await uploadString(r,pics[i],'data_url');
    urls[`p${i}`]=await getDownloadURL(r);
  }
  return urls;
}

// â”€â”€â”€ SAVE RECORD â”€â”€â”€
window.saveRec=async function(e){
  e.preventDefault();ss('sync');
  try{
    const wsT=editKey?(recs.find(x=>x._key===editKey)?._ws||ws):ws==='__all__'?prompt('è«‹è¼¸å…¥å·¥ä½œå€åç¨±ï¼š')||'general':ws;
    const data={
      customerName:document.getElementById('f_cust').value,
      repairItem:document.getElementById('f_item').value,
      technician:document.getElementById('f_tech').value,
      repairDate:document.getElementById('f_date').value,
      status:document.getElementById('f_stat').value,
      notes:document.getElementById('f_notes').value,
      updatedBy:me,updatedAt:serverTimestamp()
    };
    const key=editKey||push(ref(db,`workspaces/${wsT}/records`)).key;
    const pu=await upPics(key,wsT);
    if(Object.keys(pu).length)data.photos=pu;
    if(editKey){const ex=recs.find(r=>r._key===editKey);if(ex?.photos)data.photos={...ex.photos,...data.photos};}
    else{data.createdBy=me;data.createdAt=serverTimestamp();}
    await set(ref(db,`workspaces/${wsT}/records/${key}`),data);
    ss('online');closeRec();
  }catch(err){ss('off','å„²å­˜å¤±æ•—');alert('å„²å­˜å¤±æ•—ï¼š'+err.message);}
};

// â”€â”€â”€ DELETE â”€â”€â”€
window.delRec=async function(key,rws){
  if(role!=='admin'){alert('åƒ…ç®¡ç†å“¡å¯åˆªé™¤');return;}
  if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤ç´€éŒ„ï¼Ÿ'))return;
  ss('sync');
  try{await remove(ref(db,`workspaces/${rws}/records/${key}`));ss('online');}
  catch(err){ss('off','åˆªé™¤å¤±æ•—');alert('åˆªé™¤å¤±æ•—ï¼š'+err.message);}
};

// â”€â”€â”€ ADMIN PANEL â”€â”€â”€
function renderAdmin(){renderAllWs();renderUserList();}

async function renderAllWs(){
  const el=document.getElementById('allWs');
  el.innerHTML='<div class="loading"><div class="spin"></div><p>è¼‰å…¥ä¸­...</p></div>';
  try{
    const snap=await get(ref(db,'workspaces'));
    const data=snap.val()||{};
    const keys=Object.keys(data);
    if(!keys.length){el.innerHTML='<p style="color:#6c757d;font-size:13px">ç›®å‰æ²’æœ‰å·¥ä½œå€</p>';return;}
    el.innerHTML=`<div style="display:flex;flex-wrap:wrap;gap:8px">
      ${keys.map(w=>{
        const cnt=Object.keys(data[w].records||{}).length;
        return `<div class="ws-tag" onclick="quickFilter('${w}')">ğŸ—‚ï¸ ${w} <span class="ws-count">${cnt}ç­†</span></div>`;
      }).join('')}
    </div><p style="font-size:12px;color:#6c757d;margin-top:10px">é»æ“Šå¯å¿«é€Ÿç¯©é¸è©²å·¥ä½œå€</p>`;
  }catch(err){el.innerHTML='<p style="color:#dc3545">è¼‰å…¥å¤±æ•—</p>';}
}
window.quickFilter=function(wsName){goTab('records');document.getElementById('searchQ').value=wsName;doSearch();};

async function renderUserList(){
  const el=document.getElementById('userList');
  el.innerHTML='<div class="loading"><div class="spin"></div><p>è¼‰å…¥ä¸­...</p></div>';
  try{
    const snap=await get(ref(db,`${ADMIN_KEY}/users`));
    const data=snap.val()||{};
    const users=Object.keys(data);
    if(!users.length){el.innerHTML='<p style="color:#6c757d;font-size:13px">ç›®å‰æ²’æœ‰æˆå“¡å¸³è™Ÿï¼Œè«‹é»ã€Œæ–°å¢å¸³è™Ÿã€</p>';return;}
    el.innerHTML=users.map(acc=>{
      const u=data[acc];
      return `<div class="user-row">
        <div class="user-info">
          <div class="user-avatar">${(u.name||acc)[0].toUpperCase()}</div>
          <div><div class="user-name">${u.name||acc}</div><div class="user-meta">å¸³è™Ÿï¼š${acc} | å·¥ä½œå€ï¼š${u.workspace||'-'}</div></div>
        </div>
        <div style="display:flex;gap:7px">
          <button class="btn btn-warning btn-sm" onclick="resetPw('${acc}')">ğŸ”‘ é‡è¨­å¯†ç¢¼</button>
          <button class="btn btn-danger btn-sm" onclick="delUser('${acc}')">ğŸ—‘ï¸ åˆªé™¤</button>
        </div>
      </div>`;
    }).join('');
  }catch(err){el.innerHTML='<p style="color:#dc3545">è¼‰å…¥å¤±æ•—</p>';}
}

window.openAddUser=function(){document.querySelector('#userModal form').reset();document.getElementById('userModal').classList.add('show');};
window.closeUser=function(){document.getElementById('userModal').classList.remove('show');};

window.saveUser=async function(e){
  e.preventDefault();
  const acc=document.getElementById('u_acc').value.trim();
  const name=document.getElementById('u_name').value.trim();
  const pw=document.getElementById('u_pw').value;
  const uws=document.getElementById('u_ws').value.trim()||acc;
  try{
    const ex=await get(ref(db,`${ADMIN_KEY}/users/${acc}`));
    if(ex.val()){alert('æ­¤å¸³è™Ÿå·²å­˜åœ¨ï¼Œè«‹æ›ä¸€å€‹');return;}
    await set(ref(db,`${ADMIN_KEY}/users/${acc}`),{name,password:pw,workspace:uws,createdAt:serverTimestamp()});
    alert(`âœ… å¸³è™Ÿã€Œ${acc}ã€å·²å»ºç«‹ï¼\n\nå¸³è™Ÿï¼š${acc}\nå¯†ç¢¼ï¼š${pw}\nå·¥ä½œå€ï¼š${uws}\n\nè«‹å°‡æ­¤è³‡è¨Šå‘ŠçŸ¥æˆå“¡ã€‚`);
    closeUser();renderUserList();
  }catch(err){alert('å»ºç«‹å¤±æ•—ï¼š'+err.message);}
};

window.resetPw=async function(acc){
  const np=prompt(`è«‹è¼¸å…¥ã€Œ${acc}ã€çš„æ–°å¯†ç¢¼ï¼ˆè‡³å°‘6ç¢¼ï¼‰ï¼š`);
  if(!np)return;
  if(np.length<6){alert('å¯†ç¢¼è‡³å°‘éœ€è¦6ç¢¼');return;}
  try{await set(ref(db,`${ADMIN_KEY}/users/${acc}/password`),np);alert('âœ… å¯†ç¢¼å·²é‡è¨­ï¼');}
  catch(err){alert('å¤±æ•—ï¼š'+err.message);}
};

window.delUser=async function(acc){
  if(!confirm(`ç¢ºå®šè¦åˆªé™¤å¸³è™Ÿã€Œ${acc}ã€å—ï¼Ÿ\nï¼ˆä¸æœƒåˆªé™¤è©²æˆå“¡çš„ç¶­ä¿®ç´€éŒ„ï¼‰`))return;
  try{await remove(ref(db,`${ADMIN_KEY}/users/${acc}`));alert('å¸³è™Ÿå·²åˆªé™¤');renderUserList();}
  catch(err){alert('å¤±æ•—ï¼š'+err.message);}
};

window.changeAdminPw=async function(){
  const np=document.getElementById('new_pw').value;
  const cp=document.getElementById('cfm_pw').value;
  if(!np){alert('è«‹è¼¸å…¥æ–°å¯†ç¢¼');return;}
  if(np.length<6){alert('å¯†ç¢¼è‡³å°‘éœ€è¦6ç¢¼');return;}
  if(np!==cp){alert('å…©æ¬¡å¯†ç¢¼ä¸ä¸€è‡´');return;}
  try{
    await set(ref(db,`${ADMIN_KEY}/adminPass`),np);
    alert('âœ… ç®¡ç†å“¡å¯†ç¢¼å·²æ›´æ–°ï¼');
    document.getElementById('new_pw').value='';
    document.getElementById('cfm_pw').value='';
  }catch(err){alert('å¤±æ•—ï¼š'+err.message);}
};

window.clearWs=async function(){
  const wsT=prompt('è«‹è¼¸å…¥è¦æ¸…é™¤çš„å·¥ä½œå€åç¨±ï¼š');
  if(!wsT)return;
  const cnt=recs.filter(r=>r._ws===wsT).length;
  if(!confirm(`âš ï¸ ç¢ºå®šè¦æ¸…é™¤å·¥ä½œå€ã€Œ${wsT}ã€çš„å…¨éƒ¨ ${cnt} ç­†ç´€éŒ„å—ï¼Ÿ`))return;
  if(!confirm('å†æ¬¡ç¢ºèªï¼šæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼'))return;
  try{await remove(ref(db,`workspaces/${wsT}/records`));alert('âœ… å·²æ¸…é™¤');}
  catch(err){alert('å¤±æ•—ï¼š'+err.message);}
};

// â”€â”€â”€ KPI â”€â”€â”€
function renderKPI(){
  const total=recs.length,done=recs.filter(r=>r.status==='å·²å®Œæˆ').length;
  const wait=recs.filter(r=>r.status==='å¾…è™•ç†').length,wip=recs.filter(r=>r.status==='é€²è¡Œä¸­').length;
  const rate=total?Math.round(done/total*100):0;
  const monthly={};recs.forEach(r=>{const m=r.repairDate?.substring(0,7)||'?';monthly[m]=(monthly[m]||0)+1;});
  const months=Object.keys(monthly).sort().slice(-6);
  const maxM=Math.max(...months.map(m=>monthly[m]),1);
  const tM={},iM={},cM={};
  recs.forEach(r=>{tM[r.technician]=(tM[r.technician]||0)+1;iM[r.repairItem]=(iM[r.repairItem]||0)+1;cM[r.customerName]=(cM[r.customerName]||0)+1;});
  const topT=Object.entries(tM).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const topI=Object.entries(iM).sort((a,b)=>b[1]-a[1]).slice(0,5);
  const topC=Object.entries(cM).sort((a,b)=>b[1]-a[1]).slice(0,5);
  document.getElementById('kpiGrid').innerHTML=`
    <div class="kpi-card"><h3>ç¸½ç¶­ä¿®ä»¶æ•¸</h3><div class="kpi-val">${total}</div><div class="kpi-sub">å…¨éƒ¨ç´€éŒ„</div></div>
    <div class="kpi-card"><h3>å®Œæˆç‡</h3><div class="kpi-val">${rate}%</div><div class="kpi-sub">å·²å®Œæˆ ${done} ä»¶</div><div class="kpi-bar"><div class="kpi-fill" style="width:${rate}%"></div></div></div>
    <div class="kpi-card"><h3>å¾…è™•ç†</h3><div class="kpi-val" style="color:#856404">${wait}</div><div class="kpi-sub">éœ€è¦è·Ÿé€²</div></div>
    <div class="kpi-card"><h3>é€²è¡Œä¸­</h3><div class="kpi-val" style="color:#004085">${wip}</div><div class="kpi-sub">æ–½å·¥ä¸­</div></div>`;
  document.getElementById('kpiCharts').innerHTML=`
    <div class="chart-box"><h3>ğŸ“… è¿‘ 6 å€‹æœˆè¶¨å‹¢</h3><div class="bar-chart">${months.map(m=>`<div class="bar-item"><div class="bar" style="height:${monthly[m]/maxM*130}px" data-v="${monthly[m]}ä»¶"></div><div class="bar-lbl">${m.substring(5)}æœˆ</div></div>`).join('')}</div></div>
    <div class="chart-box"><h3>ğŸ”§ æŠ€å¸«ä»¶æ•¸ TOP 5</h3><ul class="top-list">${topT.map(([n,c],i)=>`<li><span class="rank">${i+1}</span><span class="top-name">${n}</span><span class="top-count">${c}ä»¶</span></li>`).join('')}</ul></div>
    <div class="chart-box"><h3>âš¡ å¸¸è¦‹æ•…éšœ TOP 5</h3><ul class="top-list">${topI.map(([n,c],i)=>`<li><span class="rank">${i+1}</span><span class="top-name">${n}</span><span class="top-count">${c}ä»¶</span></li>`).join('')}</ul></div>
    <div class="chart-box"><h3>ğŸ¢ å®¢æˆ¶ä»¶æ•¸ TOP 5</h3><ul class="top-list">${topC.map(([n,c],i)=>`<li><span class="rank">${i+1}</span><span class="top-name">${n}</span><span class="top-count">${c}ä»¶</span></li>`).join('')}</ul></div>`;
}

// â”€â”€â”€ PDF â”€â”€â”€
window.exportOnePDF=function(key){
  const r=recs.find(x=>x._key===key);if(!r)return;
  const {jsPDF}=window.jspdf;const doc=new jsPDF();
  doc.setFontSize(18);doc.text('ç¶­ä¿®å ±å‘Š',105,20,{align:'center'});
  doc.setFontSize(11);
  [['å®¢æˆ¶åç¨±',r.customerName],['ç¶­ä¿®é …ç›®',r.repairItem],['ç¶­ä¿®äººå“¡',r.technician],['ç¶­ä¿®æ—¥æœŸ',r.repairDate],['ç‹€æ…‹',r.status],['å‚™è¨»',r.notes||'-'],['å·¥ä½œå€',r._ws||ws],['å»ºç«‹è€…',r.createdBy||'-']].forEach(([l,v],i)=>{
    doc.setFont(undefined,'bold');doc.text(l+'ï¼š',20,40+i*10);
    doc.setFont(undefined,'normal');doc.text(String(v),65,40+i*10);
  });
  doc.save(`ç¶­ä¿®å ±å‘Š_${r.customerName}_${r.repairDate}.pdf`);
};
window.exportKpiPDF=function(){
  const {jsPDF}=window.jspdf;const doc=new jsPDF();
  const now=new Date().toLocaleDateString('zh-TW');
  const total=recs.length,done=recs.filter(r=>r.status==='å·²å®Œæˆ').length;
  const rate=total?Math.round(done/total*100):0;
  doc.setFontSize(18);doc.text('KPI çµ±è¨ˆå ±å‘Š',105,20,{align:'center'});
  doc.setFontSize(11);doc.text(`ç”¢ç”Ÿæ—¥æœŸï¼š${now}  |  ç¸½ä»¶æ•¸ï¼š${total}  |  å®Œæˆç‡ï¼š${rate}%`,105,30,{align:'center'});
  doc.line(20,35,190,35);
  let y=45;
  const tM={},iM={};recs.forEach(r=>{tM[r.technician]=(tM[r.technician]||0)+1;iM[r.repairItem]=(iM[r.repairItem]||0)+1;});
  doc.setFontSize(13);doc.setFont(undefined,'bold');doc.text('æŠ€å¸«ä»¶æ•¸ TOP 5',20,y);y+=8;
  doc.setFontSize(11);doc.setFont(undefined,'normal');
  Object.entries(tM).sort((a,b)=>b[1]-a[1]).slice(0,5).forEach(([n,c],i)=>{doc.text(`${i+1}. ${n}ï¼š${c} ä»¶`,25,y);y+=7;});
  y+=5;doc.setFontSize(13);doc.setFont(undefined,'bold');doc.text('å¸¸è¦‹æ•…éšœ TOP 5',20,y);y+=8;
  doc.setFontSize(11);doc.setFont(undefined,'normal');
  Object.entries(iM).sort((a,b)=>b[1]-a[1]).slice(0,5).forEach(([n,c],i)=>{doc.text(`${i+1}. ${n}ï¼š${c} ä»¶`,25,y);y+=7;});
  doc.save(`KPIå ±å‘Š_${now}.pdf`);
};
window.exportHistPDF=function(){
  if(!histMode)return;
  const {type,value}=histMode;
  const list=recs.filter(r=>type==='customer'?r.customerName===value:r.repairItem===value).sort((a,b)=>new Date(b.repairDate)-new Date(a.repairDate));
  const {jsPDF}=window.jspdf;const doc=new jsPDF();
  doc.setFontSize(16);doc.text(`${value} â€” æ­·å²ç´€éŒ„`,105,20,{align:'center'});
  let y=35;
  list.forEach((r,i)=>{
    if(y>260){doc.addPage();y=20;}
    doc.setFontSize(11);doc.setFont(undefined,'bold');doc.text(`${i+1}. ${r.repairDate}  ${r.repairItem}  [${r.status}]`,15,y);y+=7;
    doc.setFont(undefined,'normal');doc.setFontSize(10);doc.text(`   æŠ€å¸«ï¼š${r.technician}  å‚™è¨»ï¼š${r.notes||'-'}`,15,y);y+=9;
  });
  doc.save(`æ­·å²ç´€éŒ„_${value}.pdf`);
};
window.doExportCSV=function(){
  if(!recs.length){alert('æ²’æœ‰è³‡æ–™');return;}
  const h=['å·¥ä½œå€','å®¢æˆ¶åç¨±','ç¶­ä¿®é …ç›®','ç¶­ä¿®äººå“¡','ç¶­ä¿®æ—¥æœŸ','ç‹€æ…‹','å‚™è¨»','å»ºç«‹è€…'];
  const rows=recs.map(r=>[r._ws||ws,r.customerName,r.repairItem,r.technician,r.repairDate,r.status,r.notes||'',r.createdBy||''].map(v=>`"${v}"`).join(','));
  const csv='\uFEFF'+[h.join(','),...rows].join('\n');
  const a=document.createElement('a');
  a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8'}));
  a.download=`ç¶­ä¿®ç´€éŒ„_${tod()}.csv`;a.click();
};

// â”€â”€â”€ LIGHTBOX â”€â”€â”€
window.openLb=function(src){document.getElementById('lbImg').src=src;document.getElementById('lb').classList.add('show');};
window.closeLb=function(){document.getElementById('lb').classList.remove('show');};

// â”€â”€â”€ AUTOCOMPLETE â”€â”€â”€
function updateAC(){
  document.getElementById('custList').innerHTML=[...new Set(recs.map(r=>r.customerName))].map(c=>`<option value="${c}">`).join('');
  document.getElementById('itemList').innerHTML=[...new Set(recs.map(r=>r.repairItem))].map(i=>`<option value="${i}">`).join('');
}

// â”€â”€â”€ UTILS â”€â”€â”€
function tod(){return new Date().toISOString().split('T')[0];}
function pad(n){return String(n).padStart(2,'0');}
function fmtD(d){if(!d)return'-';const dt=new Date(d);return`${dt.getFullYear()}/${pad(dt.getMonth()+1)}/${pad(dt.getDate())}`;}
function esc(s){return(s||'').replace(/'/g,"\\'");}
function bc(s){return s==='å·²å®Œæˆ'?'bs-done':s==='é€²è¡Œä¸­'?'bs-wip':'bs-wait';}

// â”€â”€â”€ AUTO RESTORE â”€â”€â”€
if(loadSess())startApp();
</script>
</body>
</html>
